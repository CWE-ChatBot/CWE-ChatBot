# /security-test-cases Task

When this command is used, execute the following task:

# security-test-cases

Generates comprehensive security test cases in Gherkin (Behavior-Driven Development) format based on identified threats and security requirements.

## Prerequisites

- Completed threat model with identified threats
- Security requirements and acceptance criteria
- Understanding of system components and attack surfaces
- Access to system architecture documentation

## Security Test Case Generation Process

### Gherkin Format Overview

Security test cases use Gherkin syntax for clear, testable scenarios:

```gherkin
Feature: [Security Control Description]
  [Purpose statement explaining why this security control exists]
  As [stakeholder]
  I want [security control]
  So that [protection goal]

  Scenario: [Specific security test scenario]
    Given [initial system state and preconditions]
    And [additional preconditions if needed]
    When [action or attack attempt occurs]
    Then [expected security response]
    And [additional security validations]
    But [what should NOT happen]
```

### Test Case Categories

Generate test cases for each STRIDE category and major threat scenarios:

#### 1. Spoofing (Identity) Test Cases
- Authentication bypass attempts
- Token forgery and manipulation
- Identity impersonation scenarios
- Certificate validation failures

#### 2. Tampering (Integrity) Test Cases  
- Input validation and injection attacks
- Data modification attempts
- Configuration tampering
- Prompt injection (for AI systems)

#### 3. Repudiation (Accountability) Test Cases
- Audit log integrity verification
- Non-repudiation controls
- Evidence preservation
- Action traceability

#### 4. Information Disclosure (Confidentiality) Test Cases
- Unauthorized data access attempts
- Information leakage scenarios
- Error message disclosure
- Side-channel information exposure

#### 5. Denial of Service (Availability) Test Cases
- Resource exhaustion attacks
- Service disruption attempts
- Rate limiting validation
- Recovery procedures

#### 6. Elevation of Privilege (Authorization) Test Cases
- Role-based access control validation
- Privilege escalation attempts
- Authorization bypass scenarios
- Administrative function protection

## Security Test Cases Output

Generate comprehensive security test cases:

```markdown
## Security Test Cases

### Test Case Generation Date: [Date]
### Generated By: Chris (Security Agent)

### Test Coverage Summary
- **Spoofing Tests**: [Count] test scenarios
- **Tampering Tests**: [Count] test scenarios  
- **Repudiation Tests**: [Count] test scenarios
- **Information Disclosure Tests**: [Count] test scenarios
- **Denial of Service Tests**: [Count] test scenarios
- **Elevation of Privilege Tests**: [Count] test scenarios

---

## Spoofing (Identity) Test Cases

### S1: Authentication Token Validation

```gherkin
Feature: JWT Token Authentication Security
  To prevent unauthorized access through token manipulation
  As the application security system
  I must validate all JWT tokens according to security standards

  Scenario: Rejecting tampered JWT tokens
    Given the application uses JWT tokens for authentication
    And a valid JWT token exists for a legitimate user
    When an attacker modifies the token payload to change the user ID or role
    And the attacker submits this tampered token in an API request
    Then the application must detect the invalid signature
    And the request must be rejected with a 401 Unauthorized response
    And the security event must be logged with attacker details
    But no system resources or user data must be accessible to the attacker
```

### S2: OAuth Redirect URI Validation

```gherkin
Feature: OAuth 2.0 Redirect Security
  To prevent authorization code interception
  As the OAuth implementation
  I must strictly validate redirect URIs against an allow-list

  Scenario: Blocking malicious redirect URIs
    Given the application has a pre-approved list of valid redirect URIs
    When a user is tricked into clicking an OAuth link with a malicious redirect_uri
    And the malicious redirect_uri points to an attacker-controlled domain
    Then the OAuth provider or application callback must reject the request
    And the authorization code must not be sent to the malicious endpoint
    And the legitimate user account must remain secure
    But the user should receive a clear error message about the invalid redirect
```

---

## Tampering (Integrity) Test Cases

### T1: Input Validation and Sanitization

```gherkin
Feature: Input Validation Security
  To prevent injection attacks and data corruption
  As the application backend
  I must validate and sanitize all user inputs

  Scenario: Preventing SQL injection in user queries
    Given the application accepts user input for database queries
    When a malicious user submits input containing SQL injection payloads
    And the input includes patterns like '; DROP TABLE users; --
    Then the application must sanitize the malicious input
    And the query must execute safely without executing the injection
    And the database structure must remain intact
    But the query should either return safe results or fail gracefully
```

### T2: Prompt Injection Prevention (AI Systems)

```gherkin
Feature: AI Prompt Injection Security
  To prevent manipulation of AI system responses
  As the AI guardrail system
  I must sanitize user inputs before processing

  Scenario: Blocking prompt injection attempts
    Given the AI system uses prompts to generate responses
    When a user submits input containing prompt manipulation commands
    And the input includes instructions like "IGNORE ALL PREVIOUS INSTRUCTIONS"
    Then the guardrail system must sanitize the malicious instructions
    And the AI must respond based on the original system prompt
    And system prompts and internal instructions must not be disclosed
    But the AI should provide a helpful response to the legitimate query portion
```

---

## Repudiation (Accountability) Test Cases

### R1: Audit Log Integrity

```gherkin
Feature: Security Audit Logging
  To ensure accountability for all security-relevant actions
  As the security monitoring system
  I must create tamper-evident audit logs

  Scenario: Logging administrative changes with full context
    Given an administrator is authenticated to the system
    When the admin modifies another user's configuration or privileges
    Then the system must create a detailed audit log entry
    And the log must include admin ID, target user, timestamp, source IP, and full before/after state
    And the log entry must be cryptographically signed or hashed
    And the log must be stored in a tamper-evident system
    But the log must not contain sensitive data like passwords or API keys
```

### R2: Action Non-Repudiation

```gherkin
Feature: User Action Traceability  
  To prevent users from denying their actions
  As the system
  I must maintain immutable records of user activities

  Scenario: Preserving evidence of user feedback submissions
    Given a user provides feedback on an AI-generated response
    When the feedback is submitted through the user interface
    Then the system must create an immutable snapshot of the context
    And the record must include the exact message content, model used, and suggestions provided
    And the record must be cryptographically linked to the user and timestamp
    And even if original data is later modified, the feedback context must remain verifiable
    But user privacy must be maintained according to data protection policies
```

---

## Information Disclosure (Confidentiality) Test Cases

### I1: Error Message Security

```gherkin
Feature: Secure Error Handling
  To prevent information disclosure through error messages
  As the application error handler
  I must provide generic error messages to users

  Scenario: Hiding technical details in production errors
    Given the application is running in production mode
    When an internal server error occurs during request processing
    And the error generates a detailed technical stack trace
    Then the user interface must display only a generic error message
    And the response must not contain file paths, library versions, or source code
    And the full technical details must be logged only to secure server-side logs
    But users should receive enough information to report the issue effectively
```

### I2: API Key Protection

```gherkin
Feature: Secret Management Security
  To prevent unauthorized access to API credentials
  As the secret management system  
  I must protect API keys from disclosure

  Scenario: Preventing API key exposure in logs
    Given the application uses external API keys for service integration
    When an error occurs while calling an external API
    And the error handling code processes the API configuration
    Then any log entries must have API keys masked or redacted
    And error messages must not contain the actual key values
    And only authorized service accounts must be able to retrieve actual keys
    But sufficient debugging information should be available for troubleshooting
```

---

## Denial of Service (Availability) Test Cases

### D1: Rate Limiting Protection

```gherkin
Feature: API Rate Limiting
  To prevent service disruption from excessive requests
  As the API gateway
  I must enforce rate limits on all endpoints

  Scenario: Throttling excessive API requests
    Given the API has rate limits configured for each user or IP address
    When a user or attacker sends requests exceeding the defined rate limit
    And the requests are submitted in rapid succession
    Then the API gateway must reject excess requests with HTTP 429 responses
    And legitimate requests within limits must continue to be processed normally
    And the system performance for other users must remain stable
    But users should receive clear information about rate limit policies
```

### D2: Resource Exhaustion Prevention

```gherkin
Feature: Resource Consumption Limits
  To prevent resource exhaustion attacks
  As the system resource manager
  I must enforce limits on computational resources

  Scenario: Limiting expensive query processing
    Given the system processes complex user queries that consume significant resources
    When a user submits queries designed to exhaust system resources
    And the queries are computationally expensive or extremely broad
    Then the system must analyze query complexity before processing
    And queries exceeding complexity thresholds must be rejected
    And system resources must remain available for legitimate users
    But users should receive guidance on creating more efficient queries
```

---

## Elevation of Privilege (Authorization) Test Cases

### E1: Role-Based Access Control

```gherkin
Feature: User Role Enforcement
  To prevent unauthorized access to privileged functions
  As the authorization system
  I must enforce role-based access controls consistently

  Scenario: Preventing regular users from accessing admin functions
    Given a regular user is authenticated with "User" role privileges
    When the user attempts to access an admin-only API endpoint
    And the user crafts requests to admin functions like user management
    Then the system must check the user's role before processing the request
    And the request must be denied with appropriate error response
    And the attempt must be logged as a potential security incident
    But the user should receive clear messaging about insufficient privileges
```

### E2: Parameter Tampering Prevention

```gherkin
Feature: Request Parameter Security
  To prevent privilege escalation through parameter manipulation
  As the API endpoint handler
  I must validate all request parameters against user permissions

  Scenario: Ignoring user ID tampering in configuration updates
    Given a user is updating their own account configuration
    When the user includes another user's ID in the request payload
    And attempts to modify configuration for a different user account
    Then the system must ignore the user ID from the request body
    And must use only the authenticated user's ID from the session token
    And the targeted user's configuration must remain unchanged
    But the legitimate user's own configuration update should proceed normally
```

---

## Advanced Security Test Scenarios

### AS1: Supply Chain Security

```gherkin
Feature: Dependency Integrity Validation
  To prevent supply chain attacks through compromised dependencies
  As the build system
  I must validate the integrity of all external dependencies

  Scenario: Detecting tampered dependency packages
    Given the application build process downloads external dependencies
    When a dependency package has been modified or compromised
    And the package checksum no longer matches the expected value
    Then the build system must detect the integrity violation
    And the build must fail with a clear security error message
    And the compromised package must not be integrated into the application
    But legitimate dependency updates with valid checksums should proceed normally
```

### AS2: Multi-Factor Authentication Bypass

```gherkin
Feature: MFA Bypass Prevention
  To prevent authentication bypass attacks
  As the authentication system
  I must enforce MFA for all privileged operations

  Scenario: Requiring MFA for administrative actions
    Given a user with admin privileges is authenticated with single-factor authentication
    When the admin attempts to perform a sensitive operation like user role modification
    Then the system must prompt for additional authentication factors
    And the sensitive operation must not proceed without MFA verification
    And the system must track MFA compliance for audit purposes
    But routine non-sensitive operations should not require additional authentication
```

## Test Implementation Guidelines

### Automation Recommendations

1. **Integration Tests**: Implement as automated API tests using testing frameworks
2. **Security Scans**: Integrate with SAST/DAST tools for continuous validation
3. **Penetration Testing**: Use scenarios as manual testing guidelines
4. **Regression Testing**: Include in CI/CD pipeline for continuous security validation

### Test Data Management

1. **Synthetic Data**: Use non-production data for security testing
2. **Data Anonymization**: Ensure test data doesn't contain real user information  
3. **Environment Isolation**: Run security tests in isolated environments
4. **Clean-up Procedures**: Ensure test artifacts are properly removed

### Reporting and Metrics

1. **Test Coverage**: Track which threats have corresponding test cases
2. **Pass/Fail Rates**: Monitor security test success rates over time
3. **Incident Correlation**: Link test failures to actual security incidents
4. **Compliance Mapping**: Map test cases to regulatory requirements
```

## Completion Criteria

- Security test cases cover all identified threats from threat model
- Test cases are written in proper Gherkin format for automation
- Test scenarios include both positive and negative security validations
- Test cases are traceable to specific threats and security requirements
- Test implementation guidance is provided for development teams
- Test cases have been reviewed and approved by security and development stakeholders