# Story 4.3: Ephemeral Document Ingestion (EDI) - PDF and Text Processing System

## Status
Draft

## Story
**As a** cybersecurity professional using the CWE ChatBot,
**I want** the ability to upload PDF and text files for ephemeral processing without persistence,
**so that** I can analyze security documents and reports by incorporating their content into my CWE-related queries without compromising data security or creating storage liabilities.

## Acceptance Criteria
1. **AC1:** The system accepts PDF files (up to 10 MB, max 50 pages) and plain text files (any extension) through the Chainlit file upload interface, performing content sniffing to validate file types regardless of extension.
2. **AC2:** PDF processing is isolated in a separate Cloud Run service (PDF Worker) that sanitizes PDFs by removing dangerous elements (/OpenAction, /AA, XFA, embedded files) and extracts text using secure parsing libraries.
3. **AC3:** Text files are validated locally in the Chainlit service using content sniffing (printable ratio checks, encoding validation) and processed entirely in memory without disk writes.
4. **AC4:** All file processing is ephemeral with no persistence - files are processed entirely in memory, with extracted text capped at 1,000,000 characters, and all content discarded after use.
5. **AC5:** Service-to-service authentication between Chainlit and PDF Worker uses OIDC ID tokens with IAM-based access control, ensuring the PDF Worker is not publicly accessible.
6. **AC6:** The system enforces strict resource limits (60s timeout, 512Mi memory, non-root execution) and provides comprehensive error handling for malformed files, oversized uploads, and processing failures.

## Security Requirements
1. **Authentication:** Service-to-service authentication via OIDC ID tokens from GCP metadata server; PDF Worker requires IAM authorization (no public access).
2. **Authorization:** Chainlit service account has `roles/run.invoker` permission on PDF Worker only; PDF Worker service account has minimal permissions (logging only).
3. **Input Validation:** Content sniffing for text files (reject binaries, validate printable ratios); PDF magic byte validation; strict Content-Type enforcement; file size and page count limits.
4. **Data Protection:** No persistence of user content; memory-only processing; no payload logging; extracted text immediately discarded after prompt creation.
5. **Compliance:** Container security with non-root execution, read-only filesystem, minimal base images; comprehensive audit logging without content exposure.

## Tasks / Subtasks
- [ ] **Task 1: Implement PDF Worker Service (AC: 2, 5, 6)**
  - [ ] Create Flask-based PDF Worker with /extract endpoint accepting application/pdf content-type
  - [ ] Implement PDF sanitization using pikepdf (remove /OpenAction, /AA, XFA, embedded files)
  - [ ] Add text extraction using pdfminer.six with maxpages=50 limit
  - [ ] Implement resource limits enforcement (10MB max, 50 pages max, 60s timeout)
  - [ ] Create Dockerfile with qpdf dependency, non-root user, minimal base image
  - [ ] Deploy to Cloud Run with --no-allow-unauthenticated flag
  - [ ] Security validation: Verify no public access and proper IAM controls

- [ ] **Task 2: Extend Chainlit Service for File Processing (AC: 1, 3, 4)**
  - [ ] Add file upload interface using cl.AskFileMessage with 10MB limit and accept=["*/*"]
  - [ ] Implement text content sniffing function (printable ratio, encoding validation, NUL byte detection)
  - [ ] Add PDF detection using PDF magic bytes (%PDF-)
  - [ ] Implement character limit enforcement (1,000,000 chars max for extracted text)
  - [ ] Ensure all processing is memory-only with immediate content disposal
  - [ ] Security validation: Verify no disk writes and proper content validation

- [ ] **Task 3: Service-to-Service Communication (AC: 5)**
  - [ ] Implement OIDC ID token retrieval from GCP metadata server
  - [ ] Create authenticated HTTP client for PDF Worker communication
  - [ ] Add proper error handling for network failures and authentication issues
  - [ ] Implement request/response JSON handling for extracted text
  - [ ] Add timeout handling and retry logic for worker communication
  - [ ] Security validation: Verify token audience binding and secure transmission

- [ ] **Task 4: Infrastructure Deployment (AC: 6)**
  - [ ] Create Terraform configuration for both services with proper IAM setup
  - [ ] Configure service accounts with least privilege permissions
  - [ ] Set up Cloud Run services with appropriate resource limits and timeouts
  - [ ] Implement proper networking and ingress controls
  - [ ] Add monitoring and logging configuration (metadata only, no content)
  - [ ] Security validation: Verify infrastructure follows security best practices

- [ ] **Security Requirements Implementation**
  - [ ] Implement comprehensive input validation for all file uploads
  - [ ] Add content sniffing and magic byte verification
  - [ ] Configure service-to-service authentication with OIDC
  - [ ] Implement audit logging for all operations (no content logging)
  - [ ] Verify container security with non-root execution and minimal permissions

## Dev Notes

### Previous Story Insights
This is a new feature story based on the comprehensive design document at `docs/design/pdf_extraction.md`. It introduces a new capability for ephemeral document processing that aligns with the CWE ChatBot's security-first approach.

### Design Document Reference
**Complete System Design** [Source: docs/design/pdf_extraction.md]:
- System Name: Ephemeral Document Ingestion (EDI)
- Purpose: Secure, ephemeral ingestion of user files with PDF isolation
- Architecture: Chainlit service + isolated PDF Worker on Cloud Run
- Security Model: Service-to-service OIDC, no public worker access, no persistence

### Architecture Context
**Cloud Infrastructure** [Source: architecture/tech-stack.md]:
- Platform: Google Cloud Platform (GCP) with Cloud Run
- Runtime: Python 3.12 containers, minimal base images, non-root users
- Authentication: OAuth 2.0/OpenID Connect via Chainlit hooks
- Monitoring: Google Cloud Logging and Monitoring with structured logs

**Project Structure** [Source: architecture/unified-project-structure.md]:
- Primary Application: `apps/chatbot/` (Chainlit service)
- New Service: `services/pdf_worker/` (isolated PDF processing)
- Infrastructure: `infrastructure/terraform/` (IaC definitions)
- Shared Code: `packages/shared/` (common utilities and models)

### Technical Implementation Details
**PDF Worker Service**:
- Flask application with gunicorn WSGI server
- Dependencies: pikepdf (9.4.0), pdfminer.six (20240706)
- Endpoint: POST /extract with Bearer token authentication
- Resource limits: 1 CPU, 512Mi memory, 60s timeout
- Security: Non-root execution, read-only filesystem (except /tmp)

**Chainlit Service Extensions**:
- File upload via cl.AskFileMessage with 10MB limit
- Text content sniffing with printable ratio validation
- PDF magic byte detection (%PDF-)
- OIDC ID token retrieval from metadata server
- Memory-only processing with immediate disposal

### Security Architecture
**Threat Isolation** [Source: docs/design/pdf_extraction.md]:
- PDF parsing isolated in separate Cloud Run service
- Reduced blast radius for PDF-based attacks
- Content sniffing prevents disguised binary uploads
- No persistence eliminates data exfiltration risks

**Access Controls**:
- PDF Worker: `--no-allow-unauthenticated` deployment
- Service Accounts: Separate SAs with least privilege
- IAM: Chainlit SA has `roles/run.invoker` on worker only
- Network: Optional VPC connector for private networking

### File Locations
**Implementation Structure** [Source: architecture/unified-project-structure.md]:
- `apps/chatbot/src/services/file_processor.py` - File upload and processing logic
- `services/pdf_worker/app.py` - PDF Worker Flask application
- `services/pdf_worker/Dockerfile` - PDF Worker container definition
- `infrastructure/terraform/pdf_worker.tf` - Cloud Run and IAM configuration
- `packages/shared/src/models/file_models.py` - File processing data models

### Technical Constraints
**Resource Limits** [Source: docs/design/pdf_extraction.md]:
- Max upload size: 10 MB per file
- Max extracted text: 1,000,000 characters
- PDF limits: ≤50 pages, ≤60s processing timeout
- Memory limit: 512 MiB per request
- No egress to public Internet except Google APIs

**Security Constraints** [Source: architecture/security.md]:
- Input validation at all entry points
- No hardcoded secrets (Google Secret Manager)
- HTTPS/TLS enforcement for all communications
- Container security with minimal attack surface

### Threat Considerations

**Attack Surfaces**:
- PDF uploads could contain malicious embedded content (JavaScript, actions, malformed objects)
- Text file uploads could contain disguised binary content or injection payloads
- Service-to-service communication could be intercepted or spoofed
- Resource exhaustion through large files or processing bombs

**Threat Scenarios**:
- Malicious PDF attempts to execute code or escape sandbox through parser vulnerabilities
- Binary files disguised as text to bypass content validation
- Unauthorized access to PDF Worker service for data exfiltration
- DoS attacks through zip bombs, page bombs, or resource exhaustion
- OIDC token interception or replay attacks

**Required Security Controls**:
- PDF sanitization with pikepdf to remove dangerous elements
- Content sniffing and magic byte validation for all uploads
- Service-to-service OIDC authentication with audience binding
- Resource limits and timeouts to prevent abuse
- Non-root container execution with read-only filesystem

**Risk Mitigation**:
- Isolated PDF processing in separate Cloud Run service
- Memory-only processing with no disk persistence
- Comprehensive input validation and content sniffing
- IAM-based access controls with least privilege
- Audit logging without content exposure

### Testing Standards
**Test Organization** [Source: architecture/tech-stack.md]:
- Unit tests in `services/pdf_worker/tests/` for PDF processing logic
- Integration tests in `apps/chatbot/tests/integration/` for file upload workflows
- E2E tests using Playwright for complete user file upload scenarios
- Security tests for content validation, authentication, and isolation

## Testing

### Unit Tests
- [ ] Test PDF Worker sanitization function with various PDF structures
- [ ] Test text content sniffing with binary, text, and edge case files
- [ ] Test file size and page count validation logic
- [ ] Test OIDC ID token retrieval and authentication
- [ ] Test memory-only processing without disk writes
- [ ] Test character limit enforcement for extracted text
- [ ] Test error handling for malformed PDFs and invalid files

### Integration Tests
- [ ] Test complete file upload workflow from Chainlit UI to PDF Worker
- [ ] Test service-to-service authentication with real OIDC tokens
- [ ] Test file processing with various PDF types and text encodings
- [ ] Test resource limit enforcement under load
- [ ] Test worker communication failure handling and retry logic
- [ ] Test end-to-end ephemeral processing (no persistence verification)

### Security Verification
- [ ] **Secure API Key Handling:** Verify PDF Worker authentication uses OIDC tokens only, no hardcoded credentials
- [ ] **Input Validation:** Test all file uploads for proper content sniffing and magic byte validation
- [ ] **Authentication Tests:** Verify PDF Worker rejects unauthenticated requests (403 status)
- [ ] **Authorization Tests:** Confirm only authorized Chainlit service can access PDF Worker
- [ ] **Data Protection:** Validate no user content is written to disk or logged in plain text
- [ ] **Malformed Data Handling:** Test system with corrupted PDFs, binary files disguised as text, and oversized uploads
- [ ] **Container Security:** Verify non-root execution and read-only filesystem enforcement
- [ ] **Resource Exhaustion:** Test system behavior with zip bombs, page bombs, and large file uploads
- [ ] **Network Security:** Verify PDF Worker is not publicly accessible and requires proper IAM

### Manual Verification
- [ ] Upload various PDF files and verify correct text extraction in chat interface
- [ ] Upload text files with different encodings and verify proper processing
- [ ] Attempt to upload oversized files and verify proper error handling
- [ ] Check Cloud Logging for proper audit trails without content exposure
- [ ] Verify PDF Worker is inaccessible without proper authentication
- [ ] Test file upload workflow end-to-end with different file types
- [ ] Verify extracted text integrates properly with CWE ChatBot responses

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation for ephemeral PDF and text processing system based on comprehensive design document | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results
*Results from QA Agent review will be populated here*

## Security Review Results
*Results from VulnerabilityTech Agent security review will be populated here*

### Vulnerability Findings
*Security vulnerabilities identified during code review will be documented here*

### Security Compliance Status
*NIST SSDF compliance and security requirement validation status will be documented here*

### Remediation Recommendations
*Specific recommendations for addressing security issues will be provided here*