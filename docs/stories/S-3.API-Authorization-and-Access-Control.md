# Story S-3: Harden API Authorization and Access Control

**Status**: In Progress

## Story

**As a** Security Engineer,
**I want** every API endpoint to enforce strict, ownership-based authorization,
**so that** users can only access or modify their own data and cannot escalate their privileges.

## Acceptance Criteria

1.  A reusable authorization decorator or middleware is created in the Python backend.
2.  This middleware is applied to all API endpoints that handle user-specific resources (e.g., `/user/config`, `/conversations/{id}`).
3.  The middleware verifies that the `user_id` from the authenticated session token matches the `user_id` associated with the resource being requested from the database.
4.  The logic for the `/user/config` endpoint explicitly ignores or rejects any `role` or other privileged fields present in the incoming request payload.
5.  Automated integration tests verify that User A, when authenticated, receives a `403 Forbidden` or `404 Not Found` error when attempting to GET or PUT data belonging to User B.
6.  Any failed authorization attempt is logged as a "HIGH" priority security event.

## Security Requirements

1.  **Enforce Least Privilege:** The system must enforce the principle of least privilege at the API layer, ensuring users can only perform actions within their permitted scope.
2.  **Prevent IDOR:** The system must prevent Insecure Direct Object Reference (IDOR) vulnerabilities by validating resource ownership on every request.

## Tasks / Subtasks

-   [ ] **Task 1: Create Authorization Middleware** (AC: 1)
    -   [ ] Design and implement a Python decorator or middleware that can be applied to API routes.
    -   [ ] The middleware will extract the `user_id` from the session token and the resource ID from the request path/body.
-   [ ] **Task 2: Implement Ownership Check** (AC: 3)
    -   [ ] Add logic to the middleware to query the database and confirm the resource belongs to the authenticated user.
    -   [ ] If the check fails, the middleware must immediately halt the request and return a `403 Forbidden` or `404 Not Found` response.
-   [ ] **Task 3: Apply Middleware to Endpoints** (AC: 2)
    -   [ ] Identify all user-specific endpoints and apply the new authorization middleware.
-   [ ] **Task 4: Harden Configuration Endpoint** (AC: 4)
    -   [ ] Modify the `/user/config` endpoint logic to strip or reject any attempts to modify privileged fields like `role`.
-   [ ] **Task 5: Implement Security Logging** (AC: 6)
    -   [ ] In the middleware's failure path, add a call to the logging module to record the failed attempt as a "HIGH" priority event.
-   [ ] **Task 6: Write Integration Tests** (AC: 5)
    -   [ ] Create tests where a mock User A attempts to access resources owned by a mock User B and assert that the request fails with the expected error code.

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `E-1 (Role Escalation)`: Addressed by filtering privileged fields from user-controlled updates.
    * `I-3 (Cross-User Data Leakage / IDOR)`: Addressed by the ownership check middleware.
    * `T-3 (Unauthorized Config Change)`: Addressed by both the ownership check and the filtering of privileged fields.
* **PRD Reference:** Implements the core principles of `NFR34: Authentication & Authorization`.

## Testing

### Integration Tests
-   [ ] As specified in AC 5, create tests for cross-user access attempts.

### Manual Verification
-   [ ] Using two different user accounts, log in as User A and use browser developer tools or Postman to replay a request, substituting the resource ID for one belonging to User B. Verify the request is forbidden.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |
