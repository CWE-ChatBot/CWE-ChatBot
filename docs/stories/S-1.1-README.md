# Story S-1.1 Implementation: Per-User Rate Limiting

## Quick Start

### Prerequisites
1. Story S-12 completed (HTTPS Load Balancer + Cloud Armor policy exists)
2. Gateway/IAP configured to inject trusted `X-User-Id` header
3. GCP project with appropriate permissions

### One-Shot Deployment

```bash
# Configure environment
export PROJECT=cwechatbot
export POLICY=cwe-chatbot-armor
export URL_MAP=cwe-chatbot-lb
export STAGING_URL=https://cwe.crashedmind.com

# Run idempotent rollout script
bash scripts/rollout_per_user_rate_limit.sh
```

This script will:
1. ✅ Verify Load Balancer strips client X-User-Id
2. ✅ Create/update Cloud Armor per-user rule @ priority 1000
3. ✅ Run synthetic probe to verify 200→429 behavior

## Files Created

### 1. Deployment Script
**Location**: `scripts/rollout_per_user_rate_limit.sh`

**Features**:
- Idempotent (safe to run multiple times)
- Verifies header stripping configuration
- Creates/updates Cloud Armor rule with correct lowercase handling
- Includes synthetic testing
- Provides clear next steps and verification commands

**Usage**:
```bash
PROJECT=cwechatbot \
POLICY=cwe-chatbot-armor \
URL_MAP=cwe-chatbot-lb \
STAGING_URL="https://cwe.crashedmind.com" \
TEST_RATE_LIMIT=10 \
bash scripts/rollout_per_user_rate_limit.sh
```

### 2. Integration Tests
**Location**: `tests/integration/test_rate_limit_user.py`

**Test Coverage**:
- ✅ Per-user rate limits enforced (200→429)
- ✅ Multiple users have independent limits
- ✅ Header spoofing protection (client X-User-Id stripped)
- ✅ Per-IP fallback works without X-User-Id

**Usage**:
```bash
# Via pytest
STAGING_URL="https://cwe.crashedmind.com" \
TEST_RATE_LIMIT=10 \
pytest tests/integration/test_rate_limit_user.py -v

# Direct execution
STAGING_URL="https://cwe.crashedmind.com" \
python tests/integration/test_rate_limit_user.py
```

### 3. Updated Documentation
**Locations**:
- `docs/stories/S-1.1AddPer-UserEdgeRateLimitsGCPCloudArmor.md` - Story document with review feedback
- `docs/stories/S-1.Rate-Limiting-and-Budget-Monitoring.md` - Runbook updated with per-user section

## Key Implementation Details

### Header Case Handling
**CRITICAL**: Cloud Armor evaluates headers in **lowercase** within CEL expressions.

```bash
# Correct - lowercase in CEL expression and enforce-on-key-name
--expression="request.headers['x-user-id'] != null"
--enforce-on-key-name="x-user-id"

# Wrong - mixed case will not work
--expression="request.headers['X-User-Id'] != null"
```

### Load Balancer Header Stripping
**CRITICAL**: GCP requires `headerAction` wrapper for header modifications.

```bash
# Correct - with headerAction wrapper
--default-route-action='{"headerAction":{"requestHeadersToRemove":["X-User-Id"]}}'

# Wrong - missing wrapper (will fail)
--default-route-action='{"requestHeadersToRemove":["X-User-Id"]}'
```

### Rule Priority Order
```
Priority 1000: Per-user (x-user-id) → 60 rpm/user, 300s ban, DENY_429
Priority 1100: Per-IP fallback → 60 rpm/IP, 300s ban, DENY_429
Priority 2147483647: Default allow all other traffic
```

## Verification Steps

### 1. Check Load Balancer Configuration
```bash
gcloud compute url-maps describe cwe-chatbot-lb --format=json \
  | grep -i "requestheaderstoremove"
# Should show: "x-user-id" in the removal list
```

### 2. Verify Cloud Armor Rule
```bash
gcloud compute security-policies rules describe 1000 \
  --security-policy=cwe-chatbot-armor \
  --format="table(priority,action,rateLimitOptions.enforceOnKey,match.expr.expression)"
# Should show: priority=1000, enforceOnKey=HTTP_HEADER, expression with 'x-user-id'
```

### 3. Check Cloud Logging
```bash
# All rate limit blocks
gcloud logging read 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"' \
  --limit=10 --format=json

# Per-user blocks (HTTP_HEADER)
gcloud logging read 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429" AND jsonPayload.enforcedOnKey="HTTP_HEADER"' \
  --limit=10 --format=json
```

### 4. Run Integration Tests
```bash
cd /home/chris/work/CyberSecAI/cwe_chatbot_bmad
STAGING_URL="https://cwe.crashedmind.com" \
TEST_RATE_LIMIT=10 \
pytest tests/integration/test_rate_limit_user.py -v
```

## Troubleshooting

### Issue: Not seeing 429 responses
**Possible causes**:
1. X-User-Id header not being stripped by LB
   - Verify: `gcloud compute url-maps describe <URL_MAP>`
2. Gateway not injecting X-User-Id after auth
   - Check gateway logs for header injection
3. Cloud Armor rule not attached to backend service
   - Verify: `gcloud compute backend-services describe <BACKEND> --global`
4. Header case mismatch in CEL expression
   - Verify: `gcloud compute security-policies rules describe 1000`

### Issue: Per-user limits not working (falls back to per-IP)
**Possible causes**:
1. Header is lowercase in logs but uppercase in rule
   - Fix: Use `x-user-id` (lowercase) in rule expression
2. Gateway sends header in different case
   - Fix: Normalize to lowercase in rule (already done in scripts)

### Issue: Clients can spoof X-User-Id
**Possible causes**:
1. Load Balancer not stripping header on ingress
   - Fix: Add `headerAction.requestHeadersToRemove`
2. Traffic not going through Load Balancer
   - Fix: Verify Cloud Run ingress restriction

## Rollback

If per-user rate limiting causes issues:

```bash
# Remove per-user rule (keeps per-IP fallback @ 1100)
gcloud compute security-policies rules delete 1000 \
  --security-policy=cwe-chatbot-armor

# Verify per-IP rule still active
gcloud compute security-policies rules list \
  --security-policy=cwe-chatbot-armor
```

**Note**: Rollback requires no service restart or downtime.

## Next Steps

After successful deployment:
1. Monitor Cloud Logging for DENY_429 events
2. Verify `enforcedOnKey=HTTP_HEADER` in logs (not IP)
3. Set up alert policy for rate limit spikes
4. Document any user-specific rate limit exceptions
5. Consider adding dashboard for rate limiting metrics

## References

- **Story Document**: [S-1.1AddPer-UserEdgeRateLimitsGCPCloudArmor.md](S-1.1AddPer-UserEdgeRateLimitsGCPCloudArmor.md)
- **S-1 Runbook**: [S-1.Rate-Limiting-and-Budget-Monitoring.md](S-1.Rate-Limiting-and-Budget-Monitoring.md#per-user-rate-limits-s-11-enhancement)
- **Cloud Armor Docs**: https://cloud.google.com/armor/docs/rate-limiting-overview
- **CEL Expression Reference**: https://cloud.google.com/armor/docs/rules-language-reference

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Initial implementation with review feedback incorporated | Claude Code Agent |
