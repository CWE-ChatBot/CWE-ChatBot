# Story S-6: Secure and Sanitize BYO LLM Endpoint Interactions

**Status**: Approved

## Story

**As a** Security Engineer,
**I want** the system to treat all user-configured "Bring Your Own" LLM endpoints as untrusted external services,
**so that** malicious responses cannot be used to attack the user or the system.

## Acceptance Criteria

1.  All network requests from the backend to a BYO LLM endpoint must be made through a sandboxed egress proxy that enforces strict network policies (e.g., preventing SSRF attacks against internal GCP services).
2.  The response body received from a BYO LLM endpoint is sanitized to remove potentially malicious content (e.g., `<script>` tags, dangerous HTML) before being processed or displayed in the UI.
3.  A clear, persistent warning is displayed in the UI whenever a user is interacting via a custom, non-default LLM.
4.  Documentation explicitly warns users about the security and privacy risks of using untrusted third-party LLM endpoints.
5.  Automated tests verify that a response containing malicious HTML/script content from a mock BYO endpoint is properly sanitized before rendering.

## Security Requirements

1.  **Treat BYO Endpoints as Untrusted:** All user-provided endpoints must be considered potentially malicious.
2.  **Prevent Server-Side Request Forgery (SSRF):** The application server must be prevented from making unintended network requests to internal systems on behalf of a user.

## Tasks / Subtasks

-   [ ] **Task 1: Implement Egress Proxy/Firewall** (AC: 1)
-   [ ] **Task 2: Implement Response Sanitization** (AC: 2)
-   [ ] **Task 3: Create UI Warning Component** (AC: 3)
-   [ ] **Task 4: Update User Documentation** (AC: 4)
-   [ ] **Task 5: Write Sanitization Tests** (AC: 5)

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `S-3 (Malicious "Bring Your Own" LLM Endpoint)`: Addressed by treating all interactions as untrusted, sanitizing output, and using an egress proxy.

## Testing

### Manual Verification
-   [ ] Configure a BYO endpoint that points to an internal IP address and verify the request is blocked by the egress proxy.
-   [ ] Configure a BYO endpoint using a mock server that returns HTML with a `<script>alert('XSS')</script>` tag. Verify the script tag is stripped and does not execute in the browser.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |