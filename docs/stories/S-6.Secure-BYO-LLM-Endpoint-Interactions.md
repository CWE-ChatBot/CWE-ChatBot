# Story S-6: Secure and Sanitize BYO LLM Endpoint Interactions

**Status**: ‚ùå NOT SUPPORTED - See Alternative Approach Below

## Decision: BYO LLM Endpoints Not Supported

**Decision Date:** October 7, 2025
**Rationale:** "Bring Your Own" (BYO) LLM endpoints will **NOT** be supported in the hosted CWE ChatBot service due to security and operational complexity. Instead, users requiring custom LLM endpoints should deploy their own instance using the Infrastructure-as-Code (IaC) provided in Story S-11.

### Why BYO LLM Endpoints Are Not Supported

1. **Security Complexity:** Treating user-provided endpoints as untrusted external services requires:
   - Sandboxed egress proxies to prevent SSRF attacks
   - Response sanitization for malicious content (XSS, script injection)
   - Network policy enforcement to protect internal GCP services
   - Ongoing security monitoring and incident response

2. **Attack Surface:** BYO endpoints introduce significant risks:
   - Malicious LLM responses could inject harmful content
   - SSRF attacks against internal infrastructure
   - Data exfiltration through crafted responses
   - Abuse of the platform to proxy attacks

3. **Operational Burden:** Supporting arbitrary endpoints requires:
   - Complex validation and sanitization logic
   - Per-endpoint security monitoring
   - User education about risks and responsibilities
   - Incident response for compromised endpoints

4. **Better Alternative Exists:** Users requiring custom LLM endpoints can deploy their own secured instance using the IaC from [Story S-11](S-11.Infrastructure-as-CodeTF.md), which provides:
   - Complete infrastructure code (Terraform)
   - Pre-configured security controls (Model Armor, Cloud Armor, DLP)
   - Guardrails and monitoring out-of-the-box
   - Full control over LLM provider configuration

### Alternative Approach: Build Your Own (BYO)

Users requiring custom LLM endpoints should **Build Your Own** (BYO) deployment using the Infrastructure-as-Code (IaC) provided in [Story S-11: Infrastructure-as-Code (Terraform) Migration](S-11.Infrastructure-as-CodeTF.md).

#### What's Provided

The S-11 IaC includes everything needed to deploy a fully-secured CWE ChatBot instance:

- **Networking & Edge:** HTTPS Load Balancer, Cloud Armor security policies, rate limiting
- **App Runtime:** Cloud Run services with least-privilege IAM
- **Security Guardrails:** Model Armor templates, Vertex AI Safety configs, DLP templates
- **Secrets Management:** Secret Manager with IAM and rotation
- **Observability:** Cloud Logging, Monitoring, alerting policies
- **Cost Controls:** Billing budgets and notifications

#### Benefits of BYO Deployment

1. **Full Control:** Configure any LLM provider (Gemini, Vertex AI, OpenAI, Anthropic, self-hosted)
2. **Security by Default:** All guardrails (Model Armor, Cloud Armor, DLP) pre-configured
3. **Private Data:** Keep all queries and responses within your own GCP project
4. **Customization:** Modify prompt templates, RAG corpus, and security policies
5. **Compliance:** Meet regulatory requirements for data residency and sovereignty

#### How to Deploy Your Own Instance

1. **Review IaC:** Read [Story S-11](S-11.Infrastructure-as-CodeTF.md) for Terraform modules and deployment guides
2. **Configure LLM:** Set your preferred LLM provider credentials in Secret Manager
3. **Deploy Infrastructure:** Use Terraform to deploy all resources to your GCP project
4. **Verify Security:** Run security validation tests to confirm guardrails are active
5. **Customize:** Modify configurations to meet your specific requirements

### Support and Documentation

- **IaC Documentation:** [docs/stories/S-11.Infrastructure-as-CodeTF.md](S-11.Infrastructure-as-CodeTF.md)
- **Security Architecture:** [docs/LLM_GUARDRAILS.md](../LLM_GUARDRAILS.md)
- **Model Armor Setup:** [docs/stories/S-2.LLM-Input-Output-Guardrails.md](S-2.LLM-Input-Output-Guardrails.md)
- **Production Security:** [docs/stories/S-9.Cloud-Production-Security-Hardening.md](S-9.Cloud-Production-Security-Hardening.md)

---

## Original Story (For Reference)

**As a** Security Engineer,
**I want** the system to treat all user-configured "Bring Your Own" LLM endpoints as untrusted external services,
**so that** malicious responses cannot be used to attack the user or the system.

**Note:** This story is **NOT IMPLEMENTED**. The requirements below document what would have been needed if BYO endpoints were supported.

## Acceptance Criteria

1.  All network requests from the backend to a BYO LLM endpoint must be made through a sandboxed egress proxy that enforces strict network policies (e.g., preventing SSRF attacks against internal GCP services).
2.  The response body received from a BYO LLM endpoint is sanitized to remove potentially malicious content (e.g., `<script>` tags, dangerous HTML) before being processed or displayed in the UI.
3.  A clear, persistent warning is displayed in the UI whenever a user is interacting via a custom, non-default LLM.
4.  Documentation explicitly warns users about the security and privacy risks of using untrusted third-party LLM endpoints.
5.  Automated tests verify that a response containing malicious HTML/script content from a mock BYO endpoint is properly sanitized before rendering.

## Security Requirements

1.  **Treat BYO Endpoints as Untrusted:** All user-provided endpoints must be considered potentially malicious.
2.  **Prevent Server-Side Request Forgery (SSRF):** The application server must be prevented from making unintended network requests to internal systems on behalf of a user.

## Tasks / Subtasks

-   [ ] **Task 1: Implement Egress Proxy/Firewall** (AC: 1)
-   [ ] **Task 2: Implement Response Sanitization** (AC: 2)
-   [ ] **Task 3: Create UI Warning Component** (AC: 3)
-   [ ] **Task 4: Update User Documentation** (AC: 4)
-   [ ] **Task 5: Write Sanitization Tests** (AC: 5)

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `S-3 (Malicious "Bring Your Own" LLM Endpoint)`: Addressed by treating all interactions as untrusted, sanitizing output, and using an egress proxy.

## Testing

### Manual Verification
-   [ ] Configure a BYO endpoint that points to an internal IP address and verify the request is blocked by the egress proxy.
-   [ ] Configure a BYO endpoint using a mock server that returns HTML with a `<script>alert('XSS')</script>` tag. Verify the script tag is stripped and does not execute in the browser.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| Oct 7, 2025   | 2.0     | Changed to NOT SUPPORTED - Users should Build Your Own using S-11 IaC instead | Security Team |
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |