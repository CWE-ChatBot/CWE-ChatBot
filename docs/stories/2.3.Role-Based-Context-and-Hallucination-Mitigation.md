# Story 2.3: Role-Based Context Awareness & Hallucination Mitigation

**Status**: Approved

## Story

**As a** PSIRT member or developer,
**I want** the chatbot to tailor its CWE information based on my role, and I need to trust that the information is accurate,
**so that** I can get actionable and reliable advice.

## Acceptance Criteria

1.  The ChatBot explicitly prompts the user to select their role (e.g., PSIRT member, Developer, Academic Researcher, Bug Bounty Hunter, Product Manager) at the start of a new session, or provides a command/option to change role during a session (FR4).
2.  For a given CWE, the system can dynamically tailor its response content and emphasis based on the selected role (e.g., for Developers, prioritize code-level remediation steps; for PSIRT, focus on impact, advisory language, and risk assessment details) (FR4), verifiable by testing different role selections in the Chainlit UI and observing response variations.
3.  Core AI mechanisms are implemented to actively minimize AI hallucination, such as directly citing specific passages from the CWE corpus for critical information or indicating when information is derived rather than directly quoted (NFR6, FR12), verifiable by local automated tests that flag unexpected or uncited responses for known queries.
4.  The system displays a confidence score or a prioritization order alongside its CWE suggestions or answers (FR15).
5.  When the system's confidence in a mapping or a response is low or information is insufficient, it clearly states this limitation and suggests ways the user can refine their query to get a better result (FR17, NFR26), verifiable through local tests using ambiguous inputs.

## Security Requirements

1.  **Role Integrity:** User role information must be securely managed within the user's session and cannot be manipulated by user input after being set (except through the official role-change command).
2.  **No Unintended Disclosures:** Role-based views must not inadvertently expose sensitive information. For example, a "PSIRT" view should not reveal internal incident details; it should only re-frame the public CWE data.

## Tasks / Subtasks

-   [ ] **Task 1: Implement Role Selection UI** (AC: 1)
    -   [ ] Add a mechanism at the start of a Chainlit session (e.g., an action button group) for the user to select their role.
    -   [ ] Store the selected role in the `cl.user_session`.
-   [ ] **Task 2: Develop Role-Based Prompt Templating** (AC: 2, Security: 2)
    -   [ ] Create different prompt templates for the LLM based on the user's role.
    -   [ ] The templates will instruct the LLM on how to structure and prioritize the information retrieved from the vector DB (e.g., "You are helping a developer. Focus on code examples and mitigation...").
-   [ ] **Task 3: Implement Confidence Scoring** (AC: 4)
    -   [ ] The vector DB search returns a similarity score. Create a function to normalize this score into a user-friendly confidence percentage (e.g., 95% confident).
    -   [ ] Display this score in the UI next to the CWE suggestion.
-   [ ] **Task 4: Implement Citation and Low-Confidence Handling** (AC: 3, 5)
    -   [ ] Enhance the response generation to include citations (e.g., "According to the CWE description...") for key facts.
    -   [ ] If the confidence score is below a defined threshold (e.g., 70%), generate a response that explicitly states the low confidence and provides suggestions for improving the query.

## Dev Notes

* **Prompt Engineering is Key:** The success of role-based responses depends heavily on well-crafted prompts. The goal is to guide the LLM's *presentation* of factual data, not to let it invent role-specific data.
* **Confidence Thresholds:** The threshold for what constitutes a "low confidence" score will need to be tuned through testing. Start with a reasonable baseline and adjust.

## Testing

### Manual Verification

-   [ ] Start a new session and select the "Developer" role. Ask about "CWE-89". Note the response.
-   [ ] Start another new session and select the "PSIRT" role. Ask about "CWE-89". Verify that the response is structured differently and emphasizes different information (e.g., impact and detection methods).
-   [ ] Submit an ambiguous query like "my website is broken". Verify the response indicates low confidence and asks for more specific details.