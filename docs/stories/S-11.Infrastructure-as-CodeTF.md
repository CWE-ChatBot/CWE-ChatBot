# Story S-11: Infrastructure-as-Code (Terraform) Migration & Standardization (GCP)

**Priority:** High  
**Epic:** Security & Compliance → Platform Guardrails & Abuse Prevention  
**Status:** Proposed  
**Related:** S-1 (Edge Rate Limiting & Budgets), S-2 (LLM I/O Guardrails), S-9 (Cloud Production Security)

## Story

**As a** Platform Engineer,  
**I want** all cloud infrastructure and security controls expressed in **Terraform**,  
**so that** environments are consistent, auditable, and easy to change with reviewable plans.

## Scope & References

This story **codifies** the infra delivered via scripts in S-1/S-2/S-9 into Terraform modules and pipelines.  
It **does not** change runtime behavior—only how resources are managed.

### In scope to codify
- **Networking & Edge**
  - HTTPS External LB (URL map, backend service, serverless NEG to Cloud Run)
  - **Cloud Armor** security policy (S-1): per-user/per-IP rate-limit rules + final allow rule
  - Request/response header actions (HSTS, XFO, XCTO, Referrer-Policy, CSP baseline from S-9)
- **App Runtime**
  - Cloud Run service(s), revisions, min/max instances, concurrency, timeouts
  - Service accounts, IAM bindings (least privilege), workload identity
  - Artifact Registry (container), Cloud Build triggers (optional)
- **Security & Guardrails**
  - **Model Armor** template(s) (S-2) and binding to Vertex AI serving path
  - Vertex AI **Safety** config (kept as variables/locals passed at deploy time)
  - **Sensitive Data Protection (DLP)**: inspect/deidentify templates (S-2)
- **Secrets & Config**
  - Secret Manager secrets + IAM + versioning/rotation hooks
  - Environment-specific config (but **uniform limits** per S-1 remain uniform)
- **Observability**
  - Cloud Logging: **log-based metrics** for guardrail and rate-limit blocks
  - Cloud Monitoring: **notification channel(s)**, **alert policies** (S-1/S-2 patterns), dashboards (optional)
- **Cost Controls**
  - **Billing Budgets**: daily & monthly budgets + notifications (S-1)
- **State & Pipelines**
  - Terraform state backend (GCS) with locking/versioning
  - CI stages: fmt/validate/plan/policy-check, manual approval, apply

> Out of scope: Application code changes, prompt templates, or auth flows (covered in S-5/S-3).

## Acceptance Criteria

1. **Single source of truth:** All listed resources exist in Terraform; manual/script drift is eliminated.  
2. **Non-disruptive migration:** Existing resources created by scripts are **imported** into state; no replacement occurs in prod during adoption.  
3. **State mgmt:** Remote state in **GCS** with locking & versioning; per-workspace isolation (`dev`, `staging`, `prod`).  
4. **Modules & naming:** A reusable **modules/** layout with consistent naming/labels (`project`, `env`, `owner`, `cost_center`).  
5. **Security parity:** Terraform expresses S-1/S-2/S-9 controls exactly:
   - Cloud Armor rules: **per-user** (header `X-User-Id`), **per-IP**, **final allow (2147483647)**.
   - DLP inspect/deidentify templates; Model Armor template; logging/alerts identical to scripts.
   - Secret Manager usage and IAM least-privilege for runtime identities.
6. **Pipelines:** CI produces **plans** for each env and requires **manual approval** for apply on `staging` and `prod`.  
7. **Policy checks:** `tflint` + `tfsec` (or Checkov) + **OPA/Conftest** enforce basic security (no public buckets, CMEK where required, no `--allow-unauthenticated` unless justified).  
8. **Drift detection:** Scheduled job runs `terraform plan` (read-only) weekly and posts summary; variances create a ticket.  
9. **Docs & Runbook:** A `README.md` explains how to import, plan, apply, and roll back; S-1/S-2/S-9 are referenced.

## Tasks / Subtasks

- [ ] **T1: Repo & State**
  - [ ] Create `infra/terraform/` with `modules/` and `envs/{dev,staging,prod}/`.
  - [ ] Configure remote state **GCS** bucket (versioning, retention) and backend blocks; enable locking.
  - [ ] Define providers/pins; set `required_version` and provider constraints.

- [ ] **T2: Module authoring**
  - [ ] **module_edge_lb/**: LB, URL map, backend service, serverless NEG, header actions, HTTPS certs.
  - [ ] **module_cloud_armor/**: Security policy with per-user/per-IP rate limits + **2147483647 allow**; variables for rpm/interval/ban but **defaults pinned to S-1**.
  - [ ] **module_run/**: Cloud Run service, SA, IAM, concurrency/timeouts, VPC connector (if used).
  - [ ] **module_guardrails/**: Model Armor template(s), DLP templates, log metrics + alerts shared with S-1.
  - [ ] **module_secrets/**: Secret Manager secrets, IAM bindings, optional rotation hooks.
  - [ ] **module_budgets/**: Daily & monthly budgets with notifications.

- [ ] **T3: Env compositions**
  - [ ] `envs/dev/main.tf` composes modules; same for `staging` and `prod`.
  - [ ] Variables capture project IDs, regions, domains; **uniform limit values** remain the same across envs.

- [ ] **T4: Import plan (no-replace)**
  - [ ] Inventory existing resources (from scripts).
  - [ ] Write `import.tfvars` mapping; run `terraform import` for each resource.
  - [ ] Run `terraform plan` to verify **no changes** in prod after import.

- [ ] **T5: CI/CD**
  - [ ] Add GitHub Actions (or Cloud Build) pipeline: `fmt` → `init` → `validate` → `tflint` → `tfsec`/Checkov → `plan`.
  - [ ] Manual approval step for `apply` on staging/prod.
  - [ ] Nightly/weekly **drift plan** job that comments on PR or opens an issue.

- [ ] **T6: Policy & Security**
  - [ ] Add **Conftest/OPA** policies (deny public artifacts, require HSTS header action, disallow missing final allow rule, disallow missing alert policies).
  - [ ] Document header-spoofing protections—gateway must **strip client `X-User-Id`** and set it itself (align with S-1/S-9).

- [ ] **T7: Docs & Handover**
  - [ ] `infra/terraform/README.md` with:
    - How to import existing resources safely.
    - How to run plan/apply per env.
    - Rollback strategy (revert commit → apply; or disable module;
