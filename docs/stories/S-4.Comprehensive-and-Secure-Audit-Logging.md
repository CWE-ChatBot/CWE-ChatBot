# Story S-4: Implement Comprehensive and Secure Audit Logging

**Status**: Approved

## Story

**As an** Incident Responder,
**I want** all security-critical events to be logged in a structured, tamper-resistant format,
**so that** I can effectively investigate security incidents and ensure user accountability.

## Acceptance Criteria

1.  A centralized logging module is implemented that outputs structured JSON logs to Google Cloud Logging.
2.  The following events are logged with a "SECURITY" tag: login success, login failure, BYO endpoint change (with old/new values), role change, and any event from the guardrails (Story S-2).
3.  All security logs include the authenticated `user_id`, source IP address, timestamp, and a detailed event description.
4.  The production GCP log bucket is configured with a retention policy and IAM permissions that restrict deletion, helping to mitigate log tampering.
5.  Documentation for the self-hosted model clearly states the user's responsibility for securing their own logs and includes a recommended logging configuration.

## Security Requirements

1.  **Accountability:** The system must generate non-repudiable audit trails for all security-significant actions.
2.  **Log Integrity:** Production logs must be protected from unauthorized modification or deletion to be considered a reliable source of evidence.

## Tasks / Subtasks

-   [ ] **Task 1: Configure Structured Logging** (AC: 1)
    -   [ ] Integrate a structured logging library like `structlog` into the Python application.
    -   [ ] Configure it to output logs in JSON format.
-   [ ] **Task 2: Implement Security Event Logging** (AC: 2, 3)
    -   [ ] Create a dedicated function in the logging module, e.g., `log_security_event(level, user_id, ip, message)`.
    -   [ ] Add calls to this function at all required locations in the code (auth flow, config changes, guardrails).
-   [ ] **Task 3: Configure GCP Log Bucket Security via Terraform** (AC: 4)
    -   [ ] In the Terraform configuration, define a dedicated log bucket for production.
    -   [ ] Apply a resource-based IAM policy to the bucket that prevents log deletion, even by project owners (Object Lock or similar).
    -   [ ] Configure a log retention policy that meets compliance requirements.
-   [ ] **Task 4: Create Self-Hosting Documentation** (AC: 5)
    -   [ ] Add a new section to the deployment documentation for self-hosters.
    -   [ ] Explain the importance of log security and provide configuration examples for common logging setups (e.g., local filebeat to ELK stack).

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `R-1 (Insufficient Auditing)`: Addressed by logging all critical security events.
    * `R-2 (Log Tampering)`: Mitigated by the secure GCP log bucket configuration.
    * `R-3 (Self-host Accountability)`: Addressed by providing clear documentation for self-hosters.
* **PRD Reference:** Implements `NFR11` and `NFR40`.

## Testing

### Manual Verification
-   [ ] Perform a security-relevant action (e.g., a failed login).
-   [ ] Navigate to the GCP Logging explorer and query for the log entry.
-   [ ] Verify the log is in structured JSON format and contains all the required fields (user, IP, timestamp, etc.).
-   [ ] Attempt to delete the log bucket in the GCP console and verify the action is denied.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |