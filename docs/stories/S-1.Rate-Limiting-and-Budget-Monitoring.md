# Story S-1: Rate Limiting & Budget Monitoring (Cloud Run Built-in)

- **Priority:** High
- **Epic:** Security & Compliance → Platform Guardrails & Abuse Prevention
- **Status:** ✅ Complete (Implemented 2025-10-07)
- **Related:** S-2 (LLM I/O Guardrails), S-9 (Cloud Production Security), S-1.1 (Load Balancer + Cloud Armor)

> **Architecture Decision:**
> - **Current:** Cloud Run service is directly exposed via `.run.app` URL (no Load Balancer)
> - **This Story (S-1):** Use Cloud Run built-in **capacity limiting** (max-instances + concurrency)
> - **Future (S-1.1):** Add HTTPS Load Balancer + Cloud Armor for **per-IP rate limiting** when needed
>
> **Rationale:** Cloud Armor requires HTTPS Load Balancer. For immediate protection, we'll use Cloud Run's built-in **capacity controls** (service-level throughput, not per-IP rpm). When custom domain or **per-IP/per-user** limits are needed, deploy **S-1.1**.

## Story

**As a** System Administrator,
**I want** service-level capacity limits and configurable **GCP billing alerts**,
**so that** API flooding and financial exhaustion are prevented at the Cloud Run service level.

## Acceptance Criteria

1. **Cloud Run capacity limiting (service-level):**

   * Max instances: **10** (prevents runaway scaling)
   * Concurrency: **80** requests per instance (Cloud Run default)
   * Effective limit: ~800 concurrent requests max across all instances
   * Under sustained load, requests **queue** or may receive **HTTP 503** (service unavailable)
   * **Note:** This is service-level throughput control (not per-IP/per-user rpm). For per-IP/per-user, see **S-1.1** (LB + Cloud Armor)
2. **Uniform configuration:** Same limits in **staging/prod**. Dev may use lower values for cost control.
3. **Observability:** Monitor Cloud Run metrics for instance count, request count, and 503 errors via Cloud Monitoring.
4. **Budgets & alerts:** **Monthly** ($100) budget created via setup script (Budgets API supports MONTH/QUARTER/YEAR). Optional "daily" alerts should be implemented via **Cloud Monitoring cost metrics** or **Billing export** (not in this story).
5. **Integration tests:** Verify max-instances limit enforced, monitor instance scaling behavior.
6. **Runbook:** Includes tuning knobs (max-instances, concurrency), triage steps, and migration path to S-1.1.
7. **Future (S-1.1):** When Load Balancer added, migrate to Cloud Armor for per-IP rate limiting with ban duration.

## Tasks

* **T1: Configure Cloud Run capacity limits**

  * Update Cloud Run service with max-instances and concurrency limits:
    ```bash
    gcloud run services update cwe-chatbot \
      --region=us-central1 \
      --max-instances=10 \
      --concurrency=80 \
      --execution-environment=gen2
    # Optional: keep CPU fully allocated during requests (lower latency, higher cost)
    # --no-cpu-throttling
    ```
  * Verify configuration: `gcloud run services describe cwe-chatbot --region=us-central1`

* **T2: Budgets (scripts)**

  * `scripts/setup_budgets.sh` creates a **monthly** ($100) budget via the Billing Budgets API (REST) with email notification enabled.
  * "Daily" alerts: out of scope for the Budgets API; see runbook note on Monitoring alternatives.
  * Script already complete and tested (see scripts/README.md)

* **T3: Observability**

  * Create Cloud Monitoring dashboard for Cloud Run metrics:
    - Instance count (target: ≤10)
    - Request count (rate over time)
    - Request latency (p50, p95, p99)
    - Error rate (503s indicate rate limit exceeded)
  * Create alert policy: Instance count ≥9 for 5min → email warning

* **T4: Runbook**

  * Document Cloud Run rate limiting behavior
  * Tuning guide: When to adjust max-instances vs concurrency
  * Incident response: Distinguishing legitimate traffic spike vs abuse
  * Migration path to S-1.1 (Load Balancer + Cloud Armor)

* **T5: Archive Cloud Armor scripts**

  * Move `scripts/setup_rate_limits.sh`, `hit_until_429.sh`, `setup_rate_limit_observability.sh` to `docs/future/s-1.1-load-balancer/`
  * Update scripts/README.md to note these require Load Balancer (see S-1.1)

## Definition of Done

* Cloud Run service updated with **max-instances=10** and **concurrency=80** in **staging** and **prod**.
* Configuration verified via `gcloud run services describe`.
* **Monthly** ($100) budget created; notifications validated. ("Daily" alerts via Monitoring are optional and not part of this story.)
* Cloud Monitoring dashboard created showing instance count, request rate, latency, errors.
* Alert policy active: Instance count ≥9 for 5min → email notification.
* Runbook published with Cloud Run tuning guide and S-1.1 migration path.
* Cloud Armor scripts archived to `docs/future/s-1.1-load-balancer/` with S-1.1 story reference.

## Implementation Commands

### Configure Cloud Run Capacity Limits
```bash
# Set service-level capacity limits
gcloud run services update cwe-chatbot \
  --region=us-central1 \
  --max-instances=10 \
  --concurrency=80 \
  --execution-environment=gen2
# Optional: keep CPU fully allocated during requests (lower latency, higher cost)
# --no-cpu-throttling

# Verify configuration
gcloud run services describe cwe-chatbot \
  --region=us-central1 \
  --format="value(spec.template.spec.containerConcurrency,spec.template.metadata.annotations.'autoscaling.knative.dev/maxScale')"
```

### Create Monthly Budget
```bash
# Run budget setup script (creates MONTHLY budget only)
PROJECT_ID=cwechatbot \
BILLING_ACCOUNT_ID=<your-billing-account-id> \
ALERT_EMAIL=secops@example.com \
MONTHLY_BUDGET_USD=100 \
./scripts/setup_budgets.sh

# For DAILY cost alerts, use Cloud Monitoring on billing metrics (not Budgets API)
```

### Monitor Cloud Run Metrics
```bash
# Check current instance count
gcloud run services describe cwe-chatbot \
  --region=us-central1 \
  --format="value(status.traffic[0].latestRevision,status.conditions)"

# View request metrics in Cloud Console
# https://console.cloud.google.com/run/detail/us-central1/cwe-chatbot/metrics
```

## Testing

* **Instance scaling:** Send burst traffic to trigger multiple instances, verify max=10 enforced
* **Concurrency:** Monitor concurrent requests per instance via Cloud Monitoring
* **Budget alerts:** Validate daily/monthly budget notifications received at configured thresholds
* **Dashboard:** Verify Cloud Monitoring dashboard shows metrics correctly

## Runbook (Cloud Run Rate Limiting)

### Tuning Knobs
- **max-instances:** Adjust based on traffic patterns (default: 10)
- **concurrency:** Requests per instance (default: 80, max: 1000)
- **cpu-throttling:** Enable to reduce costs at expense of latency

### Incident Triage
1. **High instance count (≥9):** Legitimate traffic spike or abuse?
   - Check request patterns in Cloud Logging
   - Review source IPs (if single IP dominates, consider S-1.1 for per-IP blocks)
   - Temporarily raise max-instances if legitimate spike

2. **503 errors:** Service overloaded
   - Increase max-instances or concurrency
   - Review application performance (may need optimization)

3. **Budget alerts:** Unexpected cost increase
   - Check instance count and duration
   - Review Cloud Run pricing (CPU/memory allocation)
   - Consider lowering max-instances or optimizing cold starts

### Migration to S-1.1 (Load Balancer + Cloud Armor)
When per-IP rate limiting needed:
1. Implement S-1.1 to add HTTPS Load Balancer
2. Attach Cloud Armor policy with per-IP rules (60 rpm, 300s ban)
3. Use archived scripts in `docs/future/s-1.1-load-balancer/`
4. Keep Cloud Run max-instances as secondary protection layer

## Implementation Summary

**Deployed:** 2025-10-07

**Cloud Run Service Configuration:**
```
Service: cwe-chatbot
Region: us-central1
Max Instances: 10
Concurrency: 80 requests/instance
Effective Capacity: ~800 concurrent requests
Revision: cwe-chatbot-00157-j6d
```

**Billing Budget:**
```
Budget Name: CWE ChatBot Monthly Budget
Amount: $100 USD/month
Alert Thresholds: 50%, 90%, 100%
Billing Account: 015210-0A5DE4-AF7B27
```

**Verification Evidence:**

Cloud Run Configuration:
```bash
$ gcloud run services describe cwe-chatbot --region=us-central1 --format=yaml | grep -E "(containerConcurrency|maxScale)"
        autoscaling.knative.dev/maxScale: '10'
    spec:
      containerConcurrency: 80
```

Budget Configuration:
```bash
$ gcloud billing budgets describe 0094eed0-ca3f-4cae-ba78-a9b430efaaf4 --billing-account=015210-0A5DE4-AF7B27
displayName: CWE ChatBot Monthly Budget
amount:
  specifiedAmount:
    units: '100'
    currencyCode: EUR
budgetFilter:
  calendarPeriod: MONTH
  projects:
  - projects/258315443546
thresholdRules:
- thresholdPercent: 0.5
  spendBasis: CURRENT_SPEND
- thresholdPercent: 0.9
  spendBasis: CURRENT_SPEND
- thresholdPercent: 1.0
  spendBasis: CURRENT_SPEND
```

**Next Steps:**
- Monitor Cloud Run metrics for instance scaling and 503 errors
- Consider S-1.1 implementation when per-IP rate limiting is required

## Change Log

| Date       | Version | Description                                                                |
| ---------- | ------- | -------------------------------------------------------------------------- |
| 2025-10-07 | 3.1     | **IMPLEMENTED**: Applied max-instances=10, concurrency=80, created $100/month budget with 50/90/100% alerts. |
| 2025-10-07 | 3.0     | **ARCHITECTURE CHANGE**: Switched to Cloud Run built-in capacity limiting (max-instances + concurrency). Cloud Armor/Load Balancer deferred to S-1.1 due to direct `.run.app` deployment. |
| 2025-10-06 | 2.1     | Simplified to **per-IP** only; documented future **per-user** enhancement. |
| 2025-10-06 | 2.0     | Scripts-based bootstrap; explicit final allow; labeled metric.             |
| 2025-07-30 | 1.0     | Initial story from report.                                                 |
