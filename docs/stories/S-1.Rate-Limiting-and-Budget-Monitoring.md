# Story S-1: Implement API Rate Limiting and Budget Monitoring

**Status**: Approved

## Story

**As a** System Administrator,
**I want** robust rate limiting on all public endpoints and configurable billing alerts,
**so that** the service is protected from denial-of-service attacks and financial exhaustion.

## Acceptance Criteria

1.  A default rate limit (e.g., 60 requests per minute) is applied to all chat and API endpoints on a per-user and/or per-IP basis.
2.  Any request exceeding the defined limit is rejected with a standard `429 Too Many Requests` HTTP error response.
3.  The specific rate limit values are configurable via environment variables for each environment (staging, production).
4.  GCP billing alerts are configured via Terraform to send a notification to an administrator's email when projected costs exceed predefined daily and monthly thresholds.
5.  Automated integration tests are written to verify that the rate limit is correctly enforced and that exceeding it returns a `429` error.

## Security Requirements

1.  **Denial of Service Mitigation:** The system MUST be protected against resource exhaustion attacks (both computational and financial) by enforcing strict usage quotas.
2.  **Infrastructure as Code (IaC) Security:** All cloud resource configurations, including billing alerts, MUST be managed via IaC (Terraform) to ensure they are version-controlled, auditable, and consistently applied.

## Tasks / Subtasks

-   [ ] **Task 1: Integrate Rate Limiting Library** (AC: 1)
    -   [ ] Add a Python rate-limiting library (e.g., `Flask-Limiter` or equivalent for the chosen framework) to the project dependencies.
    -   [ ] Initialize and configure the library in the main application entry point.
-   [ ] **Task 2: Apply Rate Limits to Endpoints** (AC: 1, 2)
    -   [ ] Apply the default rate-limiting decorator/middleware to all public-facing API endpoints.
    -   [ ] Configure the rate limiter to use the user's identity or source IP as the key.
-   [ ] **Task 3: Externalize Configuration** (AC: 3)
    -   [ ] Read the rate limit values (e.g., `DEFAULT_RATE_LIMIT="60/minute"`) from environment variables.
    -   [ ] Update `.env.example` with the new rate limit variables.
-   [ ] **Task 4: Configure GCP Billing Alerts via Terraform** (AC: 4)
    -   [ ] Create a new Terraform module for GCP billing alerts.
    -   [ ] Define resources for a budget and an alert notification channel (email).
    -   [ ] Set configurable thresholds for daily and monthly projected costs.
-   [ ] **Task 5: Write Integration Tests** (AC: 5)
    -   [ ] In the integration test suite, create a test that makes repeated calls to a protected endpoint.
    -   [ ] Assert that the initial requests succeed (HTTP 200).
    -   [ ] Assert that subsequent requests beyond the limit fail with HTTP 429.

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `D-3 (Financial DoS)`: Addressed by GCP billing alerts, which provide an early warning of cost overruns from abusive usage.
    * `D-2 (API Flooding)`: Addressed by the per-user/per-IP rate limiting, which prevents a single user from overwhelming the service.
* **PRD Reference:** This story directly implements `NFR10: Security & Privacy - Quotas & Rate Limits`.

### Implementation Guidance

* **Python Library:** For a Chainlit/FastAPI backend, a library like `slowapi` is a good choice. For Flask, use `Flask-Limiter`.
* **Terraform:** The Terraform code for billing alerts should be placed in the `infrastructure/` directory of the monorepo and integrated into the main CI/CD pipeline.

## Testing

### Unit Tests

* N/A. This is primarily an integration feature.

### Integration Tests

-   [ ] As specified in AC 5, an automated test must verify the rate-limiting behavior.

### Security Verification

-   [ ] **Header Verification:** Use a tool like `curl -v` to inspect the response headers. Successful responses should contain rate-limiting headers (e.g., `X-RateLimit-Limit`, `X-RateLimit-Remaining`).
-   [ ] **Terraform Plan Review:** Manually review the `terraform plan` output to confirm the billing alert resources are being created correctly before applying.

### Manual Verification

-   [ ] Use a script or a tool like Postman to rapidly send requests to an endpoint and confirm that a `429` error is received after the limit is exceeded.
-   [ ] In the GCP Console, navigate to the "Budgets & alerts" section of Billing to confirm the new budget and alert threshold have been created by Terraform.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |