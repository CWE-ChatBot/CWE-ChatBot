# Story S-1: Edge Rate Limiting & Budget Monitoring (GCP-managed)

**Priority:** High  
**Epic:** Security & Compliance → Platform Guardrails & Abuse Prevention  
**Status:** Approved (scripts-based bootstrap)  
**Related:** S-2 (LLM I/O Guardrails), S-9 (Cloud Production Security)

## Story
**As a** System Administrator,  
**I want** rate limits enforced at the **edge** and configurable **GCP billing alerts**,  
**so that** API flooding and financial exhaustion are prevented **before** traffic reaches the app.

## Scope & References
- This story covers **edge** rate limiting (Google Cloud Armor) and **billing budgets**.
- **LLM safety** is handled by **S-2** (Model Armor, Safety, DLP).
- **TLS/HSTS/headers/WAF, request size caps** are covered by **S-9**; S-1 integrates with those controls (shared logs/alerts).

> **Implementation approach:** Use **setup scripts** (`gcloud` + REST) for a one-off bootstrap. This is acceptable for initial rollout but **less ideal for long-term drift management**. A future story may migrate these settings to Terraform.

## Acceptance Criteria
1. **Edge rate limiting** on the public entry point (Cloud Armor):
   - **Per-IP:** **60 requests/minute**.
   - **Per-user:** **60 requests/minute** keyed by a stable identity header `X-User-Id` inserted **only** by a trusted component (IAP/API gateway/JWT middleware).
   - **Window:** 60 seconds. **Ban duration:** 300 seconds.
   - **Ordering:** Per-user rule (priority 1000), per-IP rule (1100), and an explicit **final allow rule** at priority **2147483647**.
   - Over-limit requests are **blocked at the edge** with **HTTP 429**.
2. **Uniform configuration:** The same limits apply in **dev, staging, and prod**. Scripts MAY accept env vars for emergency tuning but baseline values are identical across environments.
3. **Observability:** A **log-based metric** tracks rate-limit blocks with a label extracting the **security policy name**; an **alert policy** notifies SecOps on any blocks (reuse S-2 dashboard/alerting patterns).
4. **Budgets & alerts:** **Daily** and **Monthly** **GCP Budgets** created via **setup scripts** (Billing Budgets API, REST) with email notifications when **projected** spend exceeds thresholds.
5. **Integration tests:** Black-box test hits the public endpoint: initial requests return **200**, subsequent requests beyond the limit return **429**.
6. **Runbook:** Tuning, identification, and escalation documented; cross-links to S-2 & S-9. The runbook explicitly covers **stripping client-supplied `X-User-Id`** at the edge/gateway.

## Tasks
- **T1: Cloud Armor policy (setup scripts)**
  - Create policy and rules via `scripts/setup_rate_limits.sh`:
    - Per-user rule keyed by `X-User-Id` (priority 1000).
    - Per-IP rule (priority 1100).
    - **Final explicit allow** rule at **2147483647**.
  - Attach the policy to the HTTPS Load Balancer’s backend service in front of Cloud Run.
- **T2: Identity propagation & header integrity**
  - Configure gateway/IAP/JWT middleware to **inject** `X-User-Id` from a verified claim (e.g., `sub` or hashed email).
  - Ensure the LB/gateway **strips any external `X-User-Id`** to prevent spoofing.
- **T3: Observability (setup scripts)**
  - Run `scripts/setup_rate_limit_observability.sh` to create:
    - Log-based metric for 429s with **label extractor** `policy_name = EXTRACT(jsonPayload.enforcedSecurityPolicy.name)`.
    - Alert policy that pages/email-notifies on any blocks within 5 minutes.
- **T4: Budgets (setup scripts)**
  - Run `scripts/setup_budgets.sh` to create **daily** and **monthly** budgets with email notifications.
- **T5: Tests & Runbook**
  - Black-box pytest: `tests/integration/test_rate_limit.py` proves **200 → 429** behavior.
  - Bash micro-load: `scripts/hit_until_429.sh` confirms 429 in a few seconds.
  - Publish S-1 Runbook; include rule order, header stripping, and triage steps.
- **T6: (Future)** Optional migration to Terraform once limits and processes stabilize.

## Definition of Done
- Cloud Armor policy **deployed and attached** in **staging** and **prod** with the three rules (per-user, per-IP, final allow).
- **Uniform limits** enforced; attempts to bypass via client `X-User-Id` are blocked/stripped at the edge.
- **429 behavior verified** by tests; **metric** and **alert** present and firing to SecOps.
- **Daily** and **monthly** budgets exist and notifications validated.
- **Runbook** published with links to S-2 & S-9 and header-integrity guidance.

## Dev Notes

### Threat Considerations
* **Threats Mitigated:**
  * `D-3 (Financial DoS)`: Budget alerts warn on projected spend overruns.
  * `D-2 (API Flooding)`: Per-user/per-IP limits curb abusive traffic.
* **PRD Reference:** Implements `NFR10: Security & Privacy - Quotas & Rate Limits`.

### Implementation Guidance
* **Edge-first:** Prefer Cloud Armor over in-app middleware to block early and reduce app load.
* **Headers:** Cloud Armor does **not** emit classic `X-RateLimit-*` headers. 429s originate at the edge; use logs/metrics for visibility.
* **Integrity:** The `X-User-Id` header must be **set by trusted infra** and **stripped from external requests**.

## Testing

### Integration Tests
- **Automated:**  
  - `tests/integration/test_rate_limit.py` sends N requests and asserts 200s then **429** at N+1.  
  - `scripts/hit_until_429.sh` prints codes until a **429** appears.
- **Security Verification:**  
  - Verify Logs Explorer entries include **enforcedAction=DENY_429** and the **policy_name** label.  
  - Attempt to set `X-User-Id` from a public client; confirm the edge/gateway **strips** it and the per-IP rule applies.
- **Manual Verification:**  
  - Use Postman/curl to rapidly call an endpoint and observe **429** after the limit.  
  - In the Billing console, confirm **Budgets & alerts** were created by the scripts and notifications are sent on threshold breach.

## Change Log

| Date          | Version | Description                                                                 | Author      |
|---------------|---------|-----------------------------------------------------------------------------|-------------|
| 2025-10-06    | 2.0     | Switched to setup scripts; uniform limits; final allow rule; labeled metric; header stripping note | You         |
| 2025-07-30    | 1.0     | Initial story creation from report.                                         | John (PM)   |
