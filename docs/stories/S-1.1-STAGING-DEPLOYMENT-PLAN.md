# Story S-1.1 Staging Deployment Plan

## Overview

This document outlines the **staging-safe deployment strategy** for per-user rate limiting via Cloud Armor. The strategy ensures **zero production impact** during testing and validation.

## Deployment Strategy

### Phase 1: Staging Deployment (Priority 900)
Deploy per-user rate limiting at **priority 900** (evaluated BEFORE WebSocket rules at 1000-1200).

**Why Priority 900?**
- Rules are evaluated in ascending priority order
- Priority 900 < 1000, so it's evaluated FIRST
- If X-User-Id header present → rate limit applied
- If X-User-Id header absent → falls through to WebSocket rules
- **Non-breaking**: Existing production traffic unaffected

**Current Production Rules**:
```
Priority 1000: WebSocket allow (same-origin)
Priority 1100: WebSocket deny (cross-origin)
Priority 1200: WebSocket deny (no origin)
Priority 2147483647: Default allow
```

**After Staging Deployment**:
```
Priority 900:  Per-user rate limit (STAGING - x-user-id) ← NEW
Priority 1000: WebSocket allow (same-origin)
Priority 1100: WebSocket deny (cross-origin)
Priority 1200: WebSocket deny (no origin)
Priority 2147483647: Default allow
```

### Phase 2: Validation (15-30 minutes)
Run comprehensive test suite to verify:
1. Per-user rate limiting works correctly
2. No regressions in existing functionality
3. Cloud Logging shows correct behavior

### Phase 3: Promotion to Production (Priority 1000)
After successful validation:
1. Create production rule at priority 1000
2. Delete staging rule at priority 900
3. Monitor production for 30 minutes

**Final Production Rules**:
```
Priority 1000: Per-user rate limit (PRODUCTION - x-user-id) ← PROMOTED
Priority 1100: WebSocket deny (cross-origin)
Priority 1200: WebSocket deny (no origin)
Priority 2147483647: Default allow
```

## Deployment Commands

### Step 1: Deploy to Staging (Priority 900)

```bash
cd /home/chris/work/CyberSecAI/cwe_chatbot_bmad

PROJECT=cwechatbot \
POLICY=cwe-chatbot-armor \
URL_MAP=cwe-chatbot-lb \
STAGING_URL=https://cwe.crashedmind.com \
TEST_RATE_LIMIT=10 \
bash scripts/staging_deploy_per_user_rate_limit.sh
```

**Expected Output**:
- ✅ Staging rule created at priority 900
- ✅ Quick synthetic test shows 200→429 behavior
- ✅ Production traffic continues unaffected

### Step 2: Run Integration Tests

```bash
# Set up test environment
export STAGING_URL=https://cwe.crashedmind.com
export TEST_USER_ID=staging-test-user-1
export TEST_RATE_LIMIT=10

# Run integration tests
poetry run pytest tests/integration/test_rate_limit_user.py -v

# Expected: All 4 tests pass
# - test_per_user_rate_limit_enforced
# - test_multiple_users_independent_limits
# - test_spoofing_protection_header_stripped
# - test_per_ip_fallback_without_user_header
```

### Step 3: Run E2E Tests

```bash
# Run full E2E test suite to verify no regressions
# TODO: Add your E2E test commands here

# Example (if using Playwright):
# poetry run playwright test

# Verify:
# - OAuth login works
# - WebSocket connections stable
# - Chat functionality works
# - No unexpected 429 errors for legitimate users
```

### Step 4: Monitor Cloud Logging (15 minutes)

```bash
# Watch for DENY_429 events
gcloud logging tail 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"' \
  --format=json

# Verify in logs:
# - enforcedOnKey: "HTTP_HEADER" for per-user blocks
# - enforcedOnKey: "IP" for per-IP fallback blocks
# - No unexpected blocks for legitimate traffic
```

### Step 5: Verify Cloud Logging Details

```bash
# Query recent DENY_429 events
gcloud logging read 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"' \
  --limit=20 \
  --format=json \
  | grep -E '(enforcedOnKey|enforcedSecurityPolicy|priority)'

# Expected fields:
# - jsonPayload.enforcedOnKey: "HTTP_HEADER" or "IP"
# - jsonPayload.enforcedSecurityPolicy.name: "cwe-chatbot-armor"
# - jsonPayload.enforcedSecurityPolicy.priority: "900" (staging)
```

### Step 6: Promote to Production (After Validation)

```bash
# ONLY run this after ALL tests pass and monitoring looks good
bash scripts/promote_staging_to_production.sh

# This will:
# 1. Copy staging rule config to priority 1000
# 2. Delete staging rule at priority 900
# 3. Show final production state
```

### Step 7: Post-Deployment Monitoring (30 minutes)

```bash
# Monitor production for issues
gcloud logging tail 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"'

# Check for:
# - Unexpected spike in 429 errors
# - Users reporting issues
# - False positives blocking legitimate traffic
```

## Rollback Procedures

### Rollback from Staging (Before Promotion)

```bash
# Simple: Just delete the staging rule
gcloud compute security-policies rules delete 900 \
  --security-policy=cwe-chatbot-armor

# Production rules remain unchanged
# Zero downtime, zero impact
```

### Rollback from Production (After Promotion)

```bash
# Delete the production per-user rule
gcloud compute security-policies rules delete 1000 \
  --security-policy=cwe-chatbot-armor

# Per-IP fallback at 1100 continues protecting
# WebSocket rules at 1200 still active
```

## Validation Checklist

### Before Promotion to Production

- [ ] **Staging deployment successful** (rule at priority 900)
- [ ] **Integration tests passed** (all 4 tests green)
- [ ] **E2E tests passed** (no regressions)
- [ ] **Cloud Logging verified** (enforcedOnKey shows HTTP_HEADER)
- [ ] **Monitored for 15+ minutes** (no unexpected issues)
- [ ] **Quick synthetic test passed** (200→429 behavior confirmed)
- [ ] **Production traffic unaffected** (no complaints from users)

### After Promotion to Production

- [ ] **Rule at priority 1000** (verified via gcloud describe)
- [ ] **Staging rule deleted** (priority 900 removed)
- [ ] **Monitored for 30 minutes** (no issues detected)
- [ ] **User experience normal** (no false positives)
- [ ] **Cloud Logging clean** (no unexpected DENY_429 spikes)

## Troubleshooting

### Issue: Not seeing 429 responses in tests

**Possible Causes**:
1. X-User-Id header not being injected by gateway
2. Load Balancer not configured to strip client X-User-Id
3. Cloud Armor rule not evaluating correctly

**Debug Steps**:
```bash
# 1. Check URL map for header stripping
gcloud compute url-maps describe cwe-chatbot-lb --format=json \
  | grep -i "requestheaderstoremove"

# 2. Verify Cloud Armor rule
gcloud compute security-policies rules describe 900 \
  --security-policy=cwe-chatbot-armor

# 3. Check Cloud Logging for any DENY events
gcloud logging read 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"' \
  --limit=10
```

### Issue: Tests pass but production shows false positives

**Possible Causes**:
1. Rate limit too low for production traffic
2. Users sharing X-User-Id (misconfigured gateway)
3. Bots/crawlers triggering rate limit

**Resolution**:
```bash
# Quick fix: Temporarily increase rate limit
gcloud compute security-policies rules update 1000 \
  --security-policy=cwe-chatbot-armor \
  --rate-limit-threshold-count=120  # Double the limit temporarily

# Long-term: Analyze traffic patterns and adjust
```

### Issue: WebSocket connections affected

**Possible Causes**:
1. Per-user rule interfering with WebSocket upgrade
2. X-User-Id header not present on WebSocket handshake

**Debug**:
```bash
# Check if WebSocket requests have X-User-Id
gcloud logging read 'resource.type="http_load_balancer" AND request.headers.upgrade="websocket"' \
  --limit=10 \
  --format=json

# Verify rate limiting applies to HTTP upgrade request (not frames)
```

## Testing Matrix

### Integration Tests (Automated)

| Test | Purpose | Expected Result |
|------|---------|-----------------|
| `test_per_user_rate_limit_enforced` | Verify 200→429 after limit | PASS (429 on request #11) |
| `test_multiple_users_independent_limits` | Verify user isolation | PASS (user2 succeeds when user1 blocked) |
| `test_spoofing_protection_header_stripped` | Verify header security | PASS (client X-User-Id stripped) |
| `test_per_ip_fallback_without_user_header` | Verify defense-in-depth | PASS (per-IP rule still works) |

### E2E Tests (Manual + Automated)

| Scenario | Steps | Expected Result |
|----------|-------|-----------------|
| OAuth Login | Login with Google/GitHub | SUCCESS (no rate limiting) |
| Normal Chat | Send 5-10 messages | SUCCESS (all delivered) |
| Rapid Chat | Send 20 messages quickly | SUCCESS (legitimate user not blocked) |
| WebSocket Reconnect | Disconnect/reconnect 10x | SUCCESS (reconnects work) |
| Multiple Tabs | Open 3 tabs, use simultaneously | SUCCESS (same user, shared limit) |

## Post-Deployment Monitoring

### Key Metrics to Watch

1. **Rate Limit Blocks**:
   - Metric: `DENY_429` count in Cloud Logging
   - Threshold: <5 blocks/minute (adjust based on traffic)

2. **Error Rates**:
   - Metric: 5xx responses
   - Threshold: <0.1% of total requests

3. **User Experience**:
   - Metric: Support tickets mentioning "blocked" or "429"
   - Threshold: 0 tickets for legitimate users

4. **WebSocket Stability**:
   - Metric: WebSocket connection success rate
   - Threshold: >99.5%

### Monitoring Commands

```bash
# Real-time rate limit blocks
gcloud logging tail 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"'

# Count of 429s in last hour
gcloud logging read 'resource.type="http_load_balancer" AND jsonPayload.enforcedAction="DENY_429"' \
  --freshness=1h \
  --format=json \
  | grep -c "DENY_429"

# Check for 5xx errors
gcloud logging read 'resource.type="http_load_balancer" AND httpRequest.status>=500' \
  --freshness=1h \
  --limit=20
```

## Success Criteria

Deployment is considered **successful** when:

✅ **All integration tests pass** (4/4 green)
✅ **E2E tests show no regressions** (OAuth, WebSocket, Chat all work)
✅ **Cloud Logging shows HTTP_HEADER enforcement** (not just IP)
✅ **No false positives** (legitimate users not blocked)
✅ **Production traffic stable** (no error rate spike)
✅ **Monitored for 30+ minutes** (no issues detected)
✅ **Rule at production priority 1000** (promoted from staging 900)

## Timeline Estimate

| Phase | Duration | Description |
|-------|----------|-------------|
| Staging Deployment | 5 minutes | Run staging_deploy script |
| Integration Tests | 10 minutes | Run pytest suite |
| E2E Tests | 15 minutes | Manual + automated E2E |
| Monitoring | 15 minutes | Watch Cloud Logging |
| Promotion | 5 minutes | Run promote script |
| Post-Deploy Monitor | 30 minutes | Ensure stability |
| **Total** | **~80 minutes** | Complete staging to production |

## Contact & Escalation

If issues are detected:

1. **Immediate**: Rollback via script (30 seconds)
2. **Investigation**: Check Cloud Logging, metrics
3. **Resolution**: Adjust rate limits or rule expression
4. **Validation**: Re-test before re-deploying

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Initial staging deployment plan | Claude Code Agent |
