# Story 4.1: Production Cloud Infrastructure Setup and Configuration

## Status
Draft

## Story
**As a** DevOps administrator and system operator,
**I want** a complete production cloud infrastructure with OAuth authentication, environment configuration, database setup, and policy management,
**so that** the CWE ChatBot can be deployed securely in production with proper user management, data governance, and operational controls.

## Acceptance Criteria
1. **AC1:** Google Cloud Platform production infrastructure is provisioned using Terraform including Cloud Run, Cloud SQL (PostgreSQL), Cloud Storage, and IAM configurations.
2. **AC2:** OAuth 2.0 authentication is fully configured with Google and GitHub providers, supporting both individual users and enterprise domain restrictions.
3. **AC3:** Production database includes all required tables (users, conversations, messages) with proper indexes, constraints, and security policies.
4. **AC4:** CWE policy labels table is created and populated with mapping policies (Allowed, Allowed-with-Review, Discouraged) for governance compliance.
5. **AC5:** User settings and preferences are persistently stored in PostgreSQL with proper data validation and privacy controls.
6. **AC6:** Environment variable management is implemented using Google Secret Manager with secure access patterns and rotation capabilities.
7. **AC7:** Production monitoring, logging, and alerting are configured for system health, security events, and performance metrics.
8. **AC8:** Deployment pipeline supports blue-green deployment with automated rollback capabilities and zero-downtime updates.

## Security Requirements
1. **Authentication:** OAuth 2.0 with MFA support; service account authentication for internal services; IAM-based access controls.
2. **Authorization:** Role-based access control (RBAC) with user, admin, and service roles; domain-based access restrictions for enterprise deployments.
3. **Input Validation:** All configuration inputs validated; environment variables sanitized; SQL injection prevention in all queries.
4. **Data Protection:** Encryption at rest and in transit; PII anonymization; secure secret management with rotation policies.
5. **Compliance:** GDPR compliance with data export/deletion; audit logging for all administrative actions; data retention policies.

## Tasks / Subtasks
- [ ] **Task 1: Terraform Infrastructure Provisioning (AC: 1)**
  - [ ] Create GCP project with required APIs enabled (Cloud Run, Cloud SQL, IAM, Secret Manager)
  - [ ] Provision Cloud SQL PostgreSQL 17.x instance with high availability and automated backups
  - [ ] Set up Cloud Run service configuration with CPU/memory limits and autoscaling
  - [ ] Configure VPC, subnets, and firewall rules for secure network isolation
  - [ ] Create service accounts with minimal required permissions (principle of least privilege)
  - [ ] Security validation: Verify network security and IAM permissions

- [ ] **Task 2: OAuth Authentication Configuration (AC: 2)**
  - [ ] Configure Google OAuth application with production redirect URIs and scopes
  - [ ] Set up GitHub OAuth application for enterprise integration
  - [ ] Implement domain restriction logic for enterprise deployments (@company.com)
  - [ ] Create user onboarding flow with role assignment and terms acceptance
  - [ ] Add session management with secure token handling and expiration
  - [ ] Security validation: Test OAuth flows and verify secure session handling

- [ ] **Task 3: Production Database Setup (AC: 3)**
  - [ ] Deploy database schema with users, conversations, messages, and feedback tables
  - [ ] Create database indexes for optimal query performance on user_id, session_id, timestamp
  - [ ] Implement row-level security policies for user data isolation
  - [ ] Set up database connection pooling and failover configuration
  - [ ] **Implement CWE Query Handler Connection Pooling:** Replace single long-lived database connection in CWEQueryHandler/PostgresChunkStore with proper connection pool (psycopg[pool]). Ensure connections are acquired per request and released in finally blocks to prevent concurrency issues and stale connections under multi-user load
  - [ ] Configure automated backups with point-in-time recovery capabilities
  - [ ] Security validation: Verify data isolation and access controls

- [ ] **Task 4: CWE Policy Management System (AC: 4)**
  - [ ] Create cwe_policy_labels table with mapping policies and governance metadata
  - [ ] Implement policy import/export functionality for governance teams
  - [ ] Add admin interface for policy management and bulk updates
  - [ ] Create policy validation logic in query processing to enforce governance
  - [ ] Implement audit logging for all policy changes and administrative actions
  - [ ] Security validation: Verify policy enforcement and change tracking

- [ ] **Task 5: User Settings and Preferences System (AC: 5)**
  - [ ] Extend users table with preferences JSONB field for flexible settings storage
  - [ ] Implement user settings API endpoints (GET/PUT /api/user/settings)
  - [ ] Create settings validation middleware with schema enforcement
  - [ ] Add user preferences UI components for persona selection, response verbosity, privacy controls
  - [ ] Implement settings import/export for user data portability
  - [ ] Security validation: Verify settings isolation and data validation

- [ ] **Task 6: Environment and Secret Management (AC: 6)**
  - [ ] Configure Google Secret Manager with environment-specific secrets organization
  - [ ] Implement secret rotation policies for API keys, database credentials, OAuth secrets
  - [ ] Create environment variable injection for Cloud Run deployment
  - [ ] Set up application configuration management with environment overrides
  - [ ] Add secret access logging and monitoring for security auditing
  - [ ] Security validation: Verify secret access patterns and rotation mechanisms

- [ ] **Task 7: Production Monitoring and Observability (AC: 7)**
  - [ ] Configure Google Cloud Monitoring with custom metrics for application health
  - [ ] Set up structured logging with Google Cloud Logging and log-based alerts
  - [ ] Create dashboards for system performance, user activity, and security events
  - [ ] Implement alerting for system failures, security incidents, and performance degradation
  - [ ] Add distributed tracing for request flow analysis and performance optimization
  - [ ] Security validation: Verify monitoring coverage and alert responsiveness

- [ ] **Task 8: Deployment Pipeline and Operations (AC: 8)**
  - [ ] Create GitHub Actions workflow for automated testing, building, and deployment
  - [ ] Implement blue-green deployment strategy with health checks and validation
  - [ ] Set up automated rollback triggers based on health metrics and error rates
  - [ ] Configure staging environment for pre-production testing and validation
  - [ ] Add deployment approval gates for production releases
  - [ ] Security validation: Verify deployment security and change management

- [ ] **Security Requirements Implementation**
  - [ ] Implement MFA enforcement for administrative accounts and sensitive operations
  - [ ] Add rate limiting and DDoS protection using Google Cloud Armor
  - [ ] Configure WAF rules for common web application attacks
  - [ ] Implement security scanning in CI/CD pipeline (SAST, dependency scanning)
  - [ ] Set up security incident response procedures and communication channels

## Dev Notes

### Previous Story Insights
This is the foundational production setup story that enables all subsequent development. It establishes the core infrastructure, security model, and operational capabilities needed for enterprise deployment.

### Data Models
**Users Table Extensions** [Source: architecture/data-models.md#user]:
- `preferences`: JSONB field for flexible user settings (response verbosity, persona defaults, privacy preferences)
- `oauth_provider_type`: 'google' | 'github' for provider tracking
- `oauth_provider_user_id`: External provider user identifier
- `role`: 'user' | 'admin' | 'governance' for access control
- `domain_restriction`: Optional domain validation for enterprise deployments

**CWE Policy Labels Table** [New requirement]:
```sql
CREATE TABLE cwe_policy_labels (
  cwe_id TEXT PRIMARY KEY,
  mapping_label TEXT NOT NULL, -- 'Allowed', 'Allowed-with-Review', 'Discouraged'
  notes TEXT,
  updated_by UUID REFERENCES users(id),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### API Specifications
**OAuth Endpoints** [Source: architecture/rest-api-spec.md]:
- GET /auth/login/{provider} - Initiate OAuth flow
- GET /auth/callback/{provider} - Handle OAuth callback
- POST /auth/logout - Terminate user session
- GET /auth/user - Get current user information

**Admin/Governance Endpoints**:
- GET /api/admin/policies - List CWE mapping policies
- PUT /api/admin/policies/{cwe_id} - Update policy for specific CWE
- GET /api/admin/users - User management (admin only)
- GET /api/admin/audit - Audit log access

### Component Specifications
**Infrastructure Components** [Source: architecture/tech-stack.md]:
- Google Cloud Run for containerized application hosting
- Cloud SQL PostgreSQL 14.x for structured data storage
- Google Secret Manager for secure configuration management
- Cloud Storage for file uploads and export storage
- Google Cloud Armor for WAF and DDoS protection

**Authentication Integration** [Source: architecture/tech-stack.md#authentication]:
- Chainlit OAuth hooks for seamless provider integration
- Session management with secure HTTP-only cookies
- JWT tokens for API authentication with configurable expiration

### File Locations
**Infrastructure Code** [Source: architecture/unified-project-structure.md]:
- `infrastructure/terraform/` - Complete Terraform configurations
- `apps/chatbot/src/auth/` - OAuth and session management
- `apps/chatbot/src/admin/` - Administrative interfaces and APIs
- `apps/chatbot/src/config/` - Environment and configuration management
- `.github/workflows/` - CI/CD pipeline definitions

**Database Migrations**:
- `apps/chatbot/migrations/` - Database schema versioning
- `apps/chatbot/scripts/setup_production.py` - Production setup automation

### Technical Constraints
**Cloud Infrastructure Requirements** [Source: architecture/tech-stack.md]:
- Google Cloud Platform with specific regional deployment for compliance
- PostgreSQL 14.x with pgvector extension for CWE embeddings
- Redis 6.x for session caching and rate limiting
- Terraform for Infrastructure as Code with state management

**Security and Compliance Constraints**:
- OAuth 2.0 with PKCE for secure authentication flows
- GDPR compliance with data export and deletion capabilities
- SOC 2 Type II controls for enterprise customers
- Encryption at rest and in transit for all sensitive data

**Database Connection Management**:
- Connection pooling mandatory for multi-user production environment
- CWEQueryHandler must use psycopg[pool] or equivalent connection pooling
- Per-request connection acquisition/release pattern to prevent concurrency issues
- No single long-lived database connections in production deployment

### Testing Requirements
**Infrastructure Testing**:
- Terraform plan validation and resource drift detection
- Database migration testing with rollback procedures
- OAuth flow testing with multiple providers and edge cases
- Load testing for autoscaling and performance validation

### Threat Considerations
**Attack Surfaces**:
- OAuth callback endpoints vulnerable to authorization code interception
- Database connections and credential exposure in container environments
- API endpoints without proper rate limiting and input validation
- Administrative interfaces with elevated privilege escalation risks

**Threat Scenarios**:
- OAuth token theft and session hijacking attacks
- SQL injection through administrative interfaces and policy management
- Privilege escalation from regular user to administrative access
- Data exfiltration through misconfigured access controls

**Required Security Controls**:
- OAuth state parameter validation and PKCE implementation
- Parameterized queries and input sanitization for all database operations
- Role-based access control with principle of least privilege
- Comprehensive audit logging for all administrative and data access operations

**Risk Mitigation**:
- Regular security assessments and penetration testing
- Automated vulnerability scanning in CI/CD pipeline
- Incident response procedures with defined escalation paths
- Security monitoring and alerting for suspicious activities

### Testing Standards
**Production Readiness Testing**:
- Integration tests for OAuth flows with real provider endpoints
- Database performance testing under production load scenarios
- Security testing including OWASP Top 10 vulnerability assessment
- Disaster recovery testing with backup restoration and failover procedures

## Testing

### Unit Tests
- [ ] Test OAuth provider configuration and callback handling
- [ ] Test user settings validation and JSONB schema enforcement
- [ ] Test CWE policy validation and governance rule enforcement
- [ ] Test secret management and environment variable injection
- [ ] Test database connection pooling and failover mechanisms
- [ ] Test role-based access control and permission validation
- [ ] Test audit logging and security event capture

### Integration Tests
- [ ] Test complete OAuth flow with Google and GitHub providers
- [ ] Test database schema deployment and migration procedures
- [ ] Test secret rotation and application restart procedures
- [ ] Test user onboarding flow with role assignment and domain validation
- [ ] Test policy management workflow with administrative approval
- [ ] Test monitoring and alerting with simulated failure scenarios
- [ ] Test backup and restore procedures with point-in-time recovery

### Security Verification
- [ ] **Secure API Key Handling:** Verify all production secrets are stored in Google Secret Manager and not hardcoded in application code or environment files.
- [ ] **Input Validation:** Test all administrative interfaces and OAuth callbacks for proper input validation and sanitization.
- [ ] **Authentication Tests:** Verify OAuth flows handle edge cases including expired tokens, invalid states, and provider failures.
- [ ] **Authorization Tests:** Confirm role-based access controls prevent unauthorized access to administrative functions and user data.
- [ ] **Data Protection:** Validate encryption at rest for database and in transit for all API communications.
- [ ] **Malformed Data Handling:** Test system behavior with invalid OAuth responses, malformed policy data, and corrupted user settings.
- [ ] **Security Headers:** Verify proper security headers including CSP, HSTS, and CSRF protection.
- [ ] **SQL Injection Prevention:** Test all database operations including policy management and user queries for injection vulnerabilities.
- [ ] **XSS Prevention:** Test administrative interfaces and user settings for cross-site scripting vulnerabilities.
- [ ] **Privilege Escalation:** Attempt to escalate privileges from regular user to admin through API manipulation and session tampering.

### Manual Verification
- [ ] Deploy complete infrastructure using Terraform and verify all resources are created correctly
- [ ] Test OAuth login flow with both Google and GitHub providers in production environment
- [ ] Verify user settings persistence across sessions and browser restarts
- [ ] Test policy management interface with governance team workflows
- [ ] Validate monitoring dashboards show accurate metrics and alert properly
- [ ] Test disaster recovery procedures including database restoration and application failover
- [ ] Verify GDPR compliance with data export and deletion workflows
- [ ] Test production deployment pipeline with blue-green deployment and rollback

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation for production cloud infrastructure setup | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results
*Results from QA Agent review will be populated here*

## Security Review Results
*Results from VulnerabilityTech Agent security review will be populated here*

### Vulnerability Findings
*Security vulnerabilities identified during code review will be documented here*

### Security Compliance Status
*NIST SSDF compliance and security requirement validation status will be documented here*

### Remediation Recommendations
*Specific recommendations for addressing security issues will be provided here*