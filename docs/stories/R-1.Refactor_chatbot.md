# Story R-1: Refactor Chatbot Retrieval and Response Layer

**Status**: Proposed

## Story

**As a** developer and maintainer,
**I want** a clearer, faster, and more consistent chatbot stack that reuses the ingestion RRF retrieval and standardizes on Gemini 3072‑D embeddings,
**so that** the app is easier to evolve, test, and operate with predictable quality.

## Acceptance Criteria

1. Chatbot retrieval uses the same Postgres RRF fusion as ingestion (vector + FTS + alias), returning a unified shape `{metadata, document, scores:{vec, fts, alias, hybrid}}`.
2. Persona prompts are externalized to `apps/chatbot/src/prompts/` (file-based), hot‑loadable for iteration.
3. Embedding client uses Gemini `models/embedding-001` at 3072‑D with lazy init and env validation; no OpenAI code paths remain in chatbot.
4. Blocking DB calls are isolated (psycopg3 or executor pattern) and do not block Chainlit handlers.
5. Configuration centralizes Gemini model/dimensions and RRF k‑values in `Config` with sane defaults.
6. Stronger typing for public interfaces (TypedDict/dataclasses) and passing mypy in `apps/chatbot/src`.

## Security Requirements

- No secrets in code; require env vars with validation and masked logging (e.g., `GEMINI_API_KEY`).
- Sanitized prompts and responses; central sanitizer used by response layer.

## Tasks / Subtasks

- [ ] Unify retrieval: add adapter to call ingestion `cwe_chunks` RRF query; map results to chatbot `CWEResult`.
- [ ] Align scoring fields and update `ResponseGenerator._build_context` to use `scores['hybrid']`.
- [ ] Externalize persona prompts to files; add loader with caching + reload flag.
- [ ] Replace `EmbeddingService` with a Gemini adapter (reusing `GeminiEmbedder` from ingestion or a thin client); lazy‑load with config and timeouts.
- [ ] Async safety: wrap DB calls with psycopg3/ThreadPoolExecutor and document boundaries.
- [ ] Config: add `RRF_K_VEC`, `RRF_FTS_K`, `RRF_ALIAS_K`, `RRF_K_RRF`, Gemini model/dims (3072), generation/embedding timeouts.
- [ ] Types: introduce `ChunkResult`, `HybridScores` TypedDicts and annotate public methods; fix mypy.

## Dev Notes

- Prefer server truth: the ingestion RRF SQL already optimized; reuse it to avoid score drift.
- Enforce Gemini‑only 3072‑D alignment in chatbot; remove OpenAI (1536‑D) references.
- Logging: structured, persona/model/k‑values in context; redact secrets.

## Testing

- Unit: prompt loader, sanitizer, adapters, score fusion mapping, rate limit wrapper.
- Integration: end‑to‑end query path using test DB, verifying RRF fields and non‑blocking handlers.
- Config: env matrix tests (Gemini/OpenAI, k‑values) to ensure safe defaults and overrides.
