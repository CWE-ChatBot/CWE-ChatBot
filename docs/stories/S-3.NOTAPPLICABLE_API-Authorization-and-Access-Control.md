# Story S-3: Harden API Authorization and Access Control

**Status**: ‚ùå NOT APPLICABLE - See Architecture Decision Below

## Architecture Decision: No REST API Endpoints

**Decision Date:** October 7, 2025
**Rationale:** This story assumes a traditional REST API architecture with endpoints like `/user/config` and `/conversations/{id}`. However, the CWE ChatBot uses **Chainlit**, a WebSocket-based conversational framework that does not expose traditional REST API endpoints for user data access.

### Why Traditional API Authorization Is Not Applicable

1. **Chainlit Architecture:** The application uses Chainlit's WebSocket-based real-time chat interface, not REST API endpoints. User interactions happen through:
   - WebSocket connections for chat messages
   - OAuth authentication flow (Google/GitHub) per Story 4.1
   - Session-based state management handled by Chainlit framework

2. **No Direct Resource Access:** There are no API endpoints like:
   - `/user/config` - No user configuration API
   - `/conversations/{id}` - No conversation resource endpoints
   - `/messages/{id}` - No message resource endpoints

   All user interactions are mediated through Chainlit's session management.

3. **Session-Based Security:** Chainlit handles user session isolation automatically:
   - Each WebSocket connection is tied to an authenticated session
   - Users cannot access other users' chat sessions via URL manipulation
   - No IDOR (Insecure Direct Object Reference) risk without direct resource IDs

4. **OAuth Handles Authorization:** Authentication and authorization are handled by:
   - OAuth 2.0 flow (Story 4.1) for user identity
   - Chainlit session management for isolating user conversations
   - No need for per-request ownership checks on API resources

### What Security IS Implemented

While traditional API authorization middleware is not applicable, the application implements equivalent security controls:

1. **Authentication:** OAuth 2.0 with Google/GitHub (Story 4.1)
   - Users must authenticate before accessing the chatbot
   - Session tokens validated on every WebSocket message
   - No anonymous access

2. **Session Isolation:** Chainlit framework ensures:
   - Each user's chat session is isolated
   - Users cannot access other users' conversations
   - WebSocket connections are user-specific

3. **Input Validation:** All user inputs are validated and sanitized:
   - Input sanitization (control characters, length limits)
   - Model Armor pre-sanitization (Story S-2)
   - SQL injection prevention

4. **Database Access Control:** PostgreSQL with least-privilege IAM:
   - Service accounts with minimal permissions
   - Parameterized queries prevent SQL injection
   - No direct user access to database

### Future Considerations

If the application were to expose REST API endpoints in the future (e.g., for integrations, mobile apps), this story's requirements would become applicable:

- Implement authorization middleware/decorators
- Add ownership checks on all resource endpoints
- Implement security logging for authorization failures
- Write integration tests for cross-user access attempts

For now, the Chainlit WebSocket architecture provides equivalent security through session-based isolation without requiring traditional API authorization patterns.

### Related Documentation

- **Authentication:** [Story 4.1: Authentication Implementation](S-4.1-Authentication-Mechanisms.md)
- **Input Security:** [apps/chatbot/src/input_security.py](../../apps/chatbot/src/input_security.py)
- **LLM Guardrails:** [docs/LLM_GUARDRAILS.md](../LLM_GUARDRAILS.md)
- **Database Security:** [docs/stories/S-9.Cloud-Production-Security-Hardening.md](S-9.Cloud-Production-Security-Hardening.md)

---

## Original Story (For Reference)

**As a** Security Engineer,
**I want** every API endpoint to enforce strict, ownership-based authorization,
**so that** users can only access or modify their own data and cannot escalate their privileges.

**Note:** This story is **NOT APPLICABLE** to the current Chainlit-based architecture. The requirements below document what would be needed if the application exposed traditional REST API endpoints.

## Scope Clarification

This project uses a single-role authorization model: all authenticated users have the same role and access level. Personas affect UI behavior only. This story focuses on ownership-based authorization (preventing IDOR) and request-time resource ownership validation. It does not introduce role-based access control (RBAC) or admin-only privileges.

## Acceptance Criteria

1.  A reusable authorization decorator or middleware is created in the Python backend.
2.  This middleware is applied to all API endpoints that handle user-specific resources (e.g., `/user/config`, `/conversations/{id}`).
3.  The middleware verifies that the `user_id` from the authenticated session token matches the `user_id` associated with the resource being requested from the database.
4.  The logic for the `/user/config` endpoint explicitly ignores or rejects any `role` or other privileged fields present in the incoming request payload.
5.  Automated integration tests verify that User A, when authenticated, receives a `403 Forbidden` or `404 Not Found` error when attempting to GET or PUT data belonging to User B.
6.  Any failed authorization attempt is logged as a "HIGH" priority security event.

## Security Requirements

1.  **Enforce Least Privilege:** The system must enforce the principle of least privilege at the API layer, ensuring users can only perform actions within their permitted scope.
2.  **Prevent IDOR:** The system must prevent Insecure Direct Object Reference (IDOR) vulnerabilities by validating resource ownership on every request.

## Tasks / Subtasks

-   [ ] **Task 1: Create Authorization Middleware** (AC: 1)
    -   [ ] Design and implement a Python decorator or middleware that can be applied to API routes.
    -   [ ] The middleware will extract the `user_id` from the session token and the resource ID from the request path/body.
-   [ ] **Task 2: Implement Ownership Check** (AC: 3)
    -   [ ] Add logic to the middleware to query the database and confirm the resource belongs to the authenticated user.
    -   [ ] If the check fails, the middleware must immediately halt the request and return a `403 Forbidden` or `404 Not Found` response.
-   [ ] **Task 3: Apply Middleware to Endpoints** (AC: 2)
    -   [ ] Identify all user-specific endpoints and apply the new authorization middleware.
-   [ ] **Task 4: Harden Configuration Endpoint** (AC: 4)
    -   [ ] Modify the `/user/config` endpoint logic to strip or reject any attempts to modify privileged fields like `role`.
-   [ ] **Task 5: Implement Security Logging** (AC: 6)
    -   [ ] In the middleware's failure path, add a call to the logging module to record the failed attempt as a "HIGH" priority event.
-   [ ] **Task 6: Write Integration Tests** (AC: 5)
    -   [ ] Create tests where a mock User A attempts to access resources owned by a mock User B and assert that the request fails with the expected error code.

## Dev Notes

### Threat Considerations

* **Threats Mitigated:**
    * `E-1 (Role Escalation)`: Addressed by filtering privileged fields from user-controlled updates.
    * `I-3 (Cross-User Data Leakage / IDOR)`: Addressed by the ownership check middleware.
    * `T-3 (Unauthorized Config Change)`: Addressed by both the ownership check and the filtering of privileged fields.
* **PRD Reference:** Implements the core principles of `NFR34: Authentication & Authorization`.

## Testing

### Integration Tests
-   [ ] As specified in AC 5, create tests for cross-user access attempts.

### Manual Verification
-   [ ] Using two different user accounts, log in as User A and use browser developer tools or Postman to replay a request, substituting the resource ID for one belonging to User B. Verify the request is forbidden.

## Change Log

| Date          | Version | Description                   | Author      |
|---------------|---------|-------------------------------|-------------|
| Oct 7, 2025   | 2.0     | Marked as NOT APPLICABLE - Chainlit uses WebSocket architecture, not REST API endpoints | Security Team |
| July 30, 2025 | 1.0     | Initial story creation from report. | John (PM)   |
