# **ADR: BM25 for Lexical Ranking in Hybrid Retrieval — Deferred**

## **Summary**

We evaluated whether to replace the current PostgreSQL full-text rank (`ts_rank`/`websearch_to_tsquery`) with **BM25** for the lexical component of our hybrid retrieval.
**Decision: do nothing now.** We will **keep the existing Postgres FTS path** and **not** introduce BM25 at this time.
If we revisit this, we will run a short **evaluation spike** and, if results are positive, ship BM25 **behind a feature flag** with automatic fallback to FTS.

## **Issue**

Our hybrid rank blends:

* **Vector similarity** (pgvector/halfvec) for semantic recall,
* **Postgres FTS rank** for lexical precision,
* **Alias/trigram** signal for acronyms and alternate terms.

BM25 could improve keyword-heavy queries and offer clearer length normalization, but it introduces an extension dependency and extra tuning.

## **Decision**

**Defer change.** Continue using **Postgres FTS** as the lexical scorer.
No production changes now. If we choose to explore BM25 later, we will:

1. Implement a **pluggable “lexical scorer”** abstraction (`fts` vs `bm25`) selected by a **feature flag** (`LEXICAL_SCORER=bm25|fts`).
2. Attempt BM25 at startup; if the extension is unavailable or errors, **log once and auto-fallback** to FTS.
3. Keep weighted fusion unchanged (`w_vec`, `w_fts`, `w_alias`) and preserve section boosts.

## **Status**

**Deferred** (2025-10-03). Revisit when triggers occur (see “Revisit Triggers”).

## **Details**

### **Assumptions**

* Corpus remains modest and chunked by section; semantic signal carries most of the lift.
* Portability and low ops burden are priorities.
* Managed Postgres environments may not consistently expose BM25 extensions.

### **Constraints**

* Extension availability varies across providers (Cloud SQL/RDS/etc.).
* We aim to avoid latency regressions and keep schema/index churn at zero.
* Keep the code path simple and maintainable.

### **Options Considered**

1. **Status quo (FTS only)** — **Chosen for now**

   * *Pros:* Zero new deps; portable; no tuning required.
   * *Cons:* Less control over document-length bias; some keyword queries may underperform.

2. **BM25 behind a feature flag** — **Future candidate**

   * *Pros:* Often better for short keyword queries; tunable (`k1`, `b`).
   * *Cons:* Extension dependency; tuning effort; not universally available.

3. **Replace FTS with BM25 everywhere**

   * *Pros:* Consistent lexical behavior.
   * *Cons:* Blocks deploys where extension isn’t available; hurts portability.

4. **External search (OpenSearch/Meilisearch)**

   * *Pros:* First-class BM25 and search features.
   * *Cons:* Extra infra, latency, auth, ops complexity.

### **Trade-offs (BM25 vs current FTS)**

* **Relevance (keywords):** BM25 typically improves ranking for short, exact queries; FTS can favor longer chunks.
* **Normalization:** BM25 provides explicit **k1/b**; FTS normalization is less transparent.
* **Semantics:** Neither solves synonyms; our **embeddings + alias** remain essential.
* **Ops/Portability:** FTS is built-in and portable; BM25 requires an extension.
* **Tuning:** BM25 needs parameter sweeps; FTS can still be tuned (e.g., `ts_rank` normalization, dictionaries).

### **Revisit Triggers**

Reopen this ADR and run the evaluation spike if any of the following hold for two consecutive weekly runs of `run_persona_query_tests.py`:

* **Keyword/Hybrid buckets:**

  * **MRR@10 < 0.55** or **Hit@3 < 0.70**, **and** vector weight increases do not fix it without harming semantic queries.
* **User feedback:** repeated misses on acronym/keyword-dominant searches despite alias boosting.
* **Scale:** corpus grows (e.g., >10k chunks) and FTS length bias visibly worsens precision.

### **If We Proceed: Evaluation Spike**

* Add IR metrics to the test runner: **Hit@1/3/5**, **MRR@10**, **NDCG@10**, **p50/p95 latency**, segmented by persona and query type.
* Compare **FTS vs BM25** with identical `(w_vec, w_alias)`; sweep `w_fts` and BM25 (`k1`, `b`).
* **Success criteria to enable BM25 by default (where available):**

  * ≥ **+3–5%** MRR@10 improvement on keyword/hybrid queries,
  * No significant latency regression,
  * No meaningful regression on semantic-heavy queries (≤ 1–2% loss).

### **If We Proceed: Implementation Sketch**

* **Abstraction:**

  * `LEXICAL_SCORER=fts` → current `ts_rank`/`websearch_to_tsquery`.
  * `LEXICAL_SCORER=bm25` → `bm25_score(...) AS fts_rank` (exact SQL per extension).
* **Fallback:** try BM25 on startup; on error, set scorer to `fts` and continue.
* **Weights & boosts:** unchanged; BM25 simply feeds the lexical score input.

### **Rollout Plan (Future)**

1. Ship the pluggable scorer + flag, default `fts`.
2. Run A/B on staging with persona tests; capture metrics.
3. If criteria met, enable `bm25` **only** on environments with the extension.
4. Monitor; instant rollback via flag.

## **Implications**

* **Now:** No code or infra changes.
* **Later (if pursued):** Small, localized SQL change; optional extension enablement; docs for the flag and tuning knobs.

## **Related**

* Hybrid Retrieval (vector + FTS + alias, weighted fusion).
* ADR: *Database Choice for CWE Chatbot* (PostgreSQL + pgvector).
* NFRs: Relevance, Latency SLOs, Portability.

## **Appendix: Low-Effort Improvements We Can Do Without BM25**

* Use `websearch_to_tsquery` consistently (unify chunked and single-row paths).
* Keep `unaccent` and trigram alias boosts.
* Optional lightweight query expansion for common security terms (“idor” → “insecure direct object reference”, “sqli” → “sql injection”).
* Experiment with `ts_rank` normalization variants to mitigate length bias.
