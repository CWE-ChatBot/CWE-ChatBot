# Epic 2.2 Implementation Plan: Contextual Retrieval & Basic Follow-up Questions

## Overview

This story builds upon the core NLU capabilities implemented in Story 2.1 by adding conversational context management and enhanced retrieval capabilities. The implementation will enable users to ask follow-up questions about previously discussed CWEs and retrieve more comprehensive information including relationships to other CWEs. This creates a more natural conversational experience while maintaining strict session isolation for security.

## Pre-Implementation Checklist

### Prerequisites Verification
- [ ] Story 2.1 (Core NLU & Query Matching) is completely implemented and tested
- [ ] PostgreSQL database with pgvector extension is operational
- [ ] OpenAI API integration is working for embeddings
- [ ] Chainlit application framework is functional
- [ ] HybridRAGManager and core NLU components are operational

### Tool/Environment Requirements  
- [ ] Python 3.10+ environment with Poetry
- [ ] PostgreSQL with pgvector extension
- [ ] OpenAI API access and valid API key
- [ ] Chainlit framework (latest stable version)
- [ ] pytest for testing framework

### Access Requirements
- [ ] Write access to `apps/chatbot/src/` directory structure
- [ ] Database access for testing enhanced retrieval
- [ ] Chainlit session management capabilities verified

### Architecture/Design Dependencies
- [ ] Understanding of existing HybridRAGManager implementation
- [ ] Knowledge of current query processing pipeline from Story 2.1
- [ ] Familiarity with Chainlit session management (`cl.user_session`)
- [ ] Current response formatting structure

### Security Considerations
- [ ] Session isolation requirements clearly understood
- [ ] Data minimization principles for response generation
- [ ] Context contamination prevention measures identified
- [ ] Security test plans prepared for session management

## Implementation Steps

### Phase 1: Enhanced Database Retrieval (Estimated: 2 hours)

#### Step 1.1: Extend CWE Retrieval with Relationships
**Objective**: Modify database queries to retrieve comprehensive CWE metadata including relationships

```python
# Deprecated Components Notice
This plan references legacy chatbot components (HybridRAGManager, CWERelationshipManager, contextual responder, progressive formatter). The chatbot now standardizes on Gemini (3072‑D) and reuses ingestion’s PostgresChunkStore.query_hybrid (RRF). Keep this document for historical reference; implement new work against the ingestion-aligned path.

# apps/chatbot/src/retrieval/cwe_relationship_manager.py
class CWERelationshipManager:
    def get_comprehensive_cwe_data(self, cwe_id: str) -> Dict[str, Any]:
        """Retrieve full CWE data including relationships"""
        # Implementation with relationships, consequences, etc.
    
    def get_related_cwes(self, cwe_id: str, relationship_type: str = "ChildOf") -> List[CWEResult]:
        """Get CWEs related by specific relationship types"""
        # Implementation for finding related CWEs
```

#### Step 1.2: Update Database Schema for Relationships
**Objective**: Ensure database can efficiently query CWE relationships

```sql
-- Add indexes for relationship queries
CREATE INDEX IF NOT EXISTS idx_cwe_relationships 
ON cwe_embeddings USING gin(jsonb_extract_path(relationships, 'ChildOf'));

-- Verify relationship data structure in existing records
```

#### Step 1.3: Integrate Enhanced Retrieval into HybridRAGManager
**Objective**: Update existing RAG manager to use comprehensive retrieval

```python
# Modify apps/chatbot/src/retrieval/hybrid_rag_manager.py
def search_with_relationships(self, query: str, include_relationships: bool = True):
    """Enhanced search including CWE relationships"""
    # Implementation
```

### Phase 2: Session-Based Conversational Memory (Estimated: 1.5 hours)

#### Step 2.1: Implement Session Context Manager
**Objective**: Create secure session management for conversational context

```python
# apps/chatbot/src/session/context_manager.py
class SessionContextManager:
    def set_current_cwe(self, session_id: str, cwe_id: str):
        """Store current CWE in session with security isolation"""
    
    def get_current_cwe(self, session_id: str) -> Optional[str]:
        """Retrieve current CWE from session"""
    
    def clear_session(self, session_id: str):
        """Clear session context"""
```

#### Step 2.2: Integrate Session Management into Chainlit App
**Objective**: Connect session management to Chainlit's built-in session handling

```python
# In apps/chatbot/main.py
import chainlit as cl
from src.session.context_manager import SessionContextManager

@cl.on_message
async def main(message: cl.Message):
    # Get session ID from Chainlit
    session_id = cl.user_session.get("id")
    # Use context manager for session state
```

#### Step 2.3: Implement Session Security Validation
**Objective**: Ensure sessions cannot contaminate each other

```python
# apps/chatbot/src/session/session_security.py
class SessionSecurityValidator:
    def validate_session_isolation(self, session_id: str) -> bool:
        """Verify session isolation is maintained"""
```

### Phase 3: Follow-up Query Processing (Estimated: 2.5 hours)

#### Step 3.1: Extend Query Processor for Follow-up Intents
**Objective**: Enhance NLU to detect and handle follow-up questions

```python
# apps/chatbot/src/processing/followup_processor.py
class FollowupProcessor:
    FOLLOWUP_PATTERNS = [
        "tell me more", "what about", "give an example", 
        "what are its children", "related cwes", "consequences"
    ]
    
    def detect_followup_intent(self, query: str) -> Dict[str, Any]:
        """Detect if query is a follow-up and extract intent"""
    
    def process_followup_query(self, query: str, context_cwe: str) -> Dict[str, Any]:
        """Process follow-up query with context"""
```

#### Step 3.2: Implement Context-Aware Response Generation
**Objective**: Generate responses using session context and comprehensive data

```python
# apps/chatbot/src/processing/contextual_responder.py
class ContextualResponder:
    def generate_contextual_response(self, query: str, context_cwe: str, relationship_data: Dict) -> str:
        """Generate response using context and relationships"""
```

#### Step 3.3: Update Main Query Processing Pipeline
**Objective**: Integrate follow-up processing into main pipeline

```python
# Modify apps/chatbot/src/processing/query_processor.py
def process_with_context(self, query: str, session_context: Optional[str] = None):
    """Enhanced processing with session context awareness"""
```

### Phase 4: Progressive Disclosure UI (Estimated: 1.5 hours)

#### Step 4.1: Implement Response Formatter with Progressive Disclosure
**Objective**: Create response formatting that supports "tell me more" functionality

```python
# apps/chatbot/src/formatting/progressive_response_formatter.py
class ProgressiveResponseFormatter:
    def format_summary_response(self, cwe_data: Dict) -> str:
        """Format concise summary with 'more details' option"""
    
    def format_detailed_response(self, cwe_data: Dict) -> str:
        """Format comprehensive response"""
```

#### Step 4.2: Add Chainlit UI Elements for Progressive Disclosure
**Objective**: Implement interactive UI elements for requesting more details

```python
# In main.py Chainlit integration
async def send_progressive_response(summary: str, detailed_data: Dict):
    # Send summary first
    await cl.Message(content=summary).send()
    
    # Add "Tell me more" action
    actions = [
        cl.Action(name="tell_more", value="detailed", description="Tell me more")
    ]
    await cl.Message(content="", actions=actions).send()
```

#### Step 4.3: Handle Progressive Disclosure Actions
**Objective**: Process user requests for more detailed information

```python
@cl.action_callback("tell_more")
async def on_tell_more(action):
    # Handle request for detailed information
```

## Success Criteria

✅ **Enhanced Retrieval (AC1, AC4)**
- [ ] System retrieves comprehensive CWE information including relationships
- [ ] Related CWEs are identified and returned based on relationships
- [ ] Database queries include all metadata fields

✅ **Follow-up Questions (AC2)**  
- [ ] System recognizes follow-up intents like "tell me more", "what about"
- [ ] Responses are contextually relevant to previously discussed CWE
- [ ] Session context is maintained throughout conversation

✅ **Fact-Based Responses (AC3)**
- [ ] All responses are derived from stored CWE data only
- [ ] No hallucinated information is included in responses
- [ ] Response accuracy verified against raw CWE data

✅ **Similar CWEs (AC4)**
- [ ] System can find and list related CWEs
- [ ] Relationship types (ChildOf, etc.) are properly utilized
- [ ] Related CWE suggestions are relevant and accurate

✅ **Progressive Disclosure (AC5)**
- [ ] Initial responses are concise summaries
- [ ] "Tell me more" functionality is implemented
- [ ] Detailed information is available on request

✅ **Security Requirements**
- [ ] Session isolation is strictly enforced
- [ ] No context contamination between users
- [ ] Data minimization principles are followed

## Verification Steps

### Functional Testing
1. **Basic Follow-up Flow**
   - Ask for "CWE-79" 
   - Verify concise summary is returned
   - Ask "tell me more" and verify detailed response
   - Ask "what are its children" and verify related CWEs listed

2. **Session Context Management**
   - Start conversation about CWE-89
   - Ask follow-up "what are its consequences"
   - Verify response is about CWE-89, not generic

3. **Related CWE Retrieval**
   - Query for a parent CWE (e.g., CWE-20)
   - Ask "show me similar CWEs"
   - Verify returned CWEs are genuinely related

### Integration Testing
1. **Database Integration**
   - Verify comprehensive data retrieval works
   - Test relationship queries perform efficiently
   - Validate all metadata fields are accessible

2. **Session Management Integration**  
   - Test with multiple concurrent Chainlit sessions
   - Verify no context contamination occurs
   - Validate session cleanup on disconnect

### Security Validation
1. **Session Isolation Testing**
   - Open two browser sessions simultaneously
   - Have different conversations in each
   - Verify contexts remain completely isolated

2. **Data Minimization Validation**
   - Review all response generation code
   - Ensure only CWE database data is used
   - Verify no external knowledge injection

### Manual Verification
1. **Progressive Disclosure UI**
   - Test "Tell me more" buttons appear correctly
   - Verify detailed information loads properly
   - Check UI responsiveness and usability

2. **Conversational Flow**
   - Test natural conversation patterns
   - Verify follow-up questions work intuitively
   - Validate context preservation across multiple turns

## Time Estimation

**Total Estimated Time**: 7.5 hours

**Critical Path**: 
1. Enhanced Retrieval (2 hours) → 
2. Session Management (1.5 hours) → 
3. Follow-up Processing (2.5 hours) → 
4. Progressive UI (1.5 hours)

**Dependencies**: 
- Story 2.1 completion (DONE)
- Database with relationship data structure
- Chainlit framework understanding

**Buffer Time**: +2 hours for unexpected integration issues and comprehensive testing

**Total with Buffer**: 9.5 hours

## Risk Mitigation

### Technical Risks

**Risk**: Session state management complexity in Chainlit
- **Impact**: Medium - Could delay follow-up functionality
- **Mitigation**: Start with simple session storage, iterate if needed
- **Rollback**: Use in-memory session management if Chainlit integration fails

**Risk**: Database relationship queries performance
- **Impact**: Low - Could affect response times  
- **Mitigation**: Implement proper indexing, optimize queries early
- **Rollback**: Limit relationship depth if performance issues occur

**Risk**: Context contamination between sessions
- **Impact**: High - Critical security issue
- **Mitigation**: Implement thorough session isolation testing
- **Rollback**: Disable session memory if isolation cannot be guaranteed

### Dependency Risks  

**Risk**: Story 2.1 implementation gaps affecting integration
- **Impact**: Medium - Could require Story 2.1 modifications
- **Mitigation**: Thorough review of Story 2.1 code before starting
- **Rollback**: Fix Story 2.1 issues first, then continue

### Timeline Risks

**Risk**: Progressive disclosure UI more complex than expected  
- **Impact**: Low - Could extend timeline by 1-2 hours
- **Mitigation**: Start with simple implementation, enhance iteratively
- **Rollback**: Use text-based "tell me more" without UI buttons

## Next Steps

After Story 2.2 completion:

1. **Integration Points**
   - Prepare for Story 2.3 role-based context requirements
   - Ensure session management scales for user authentication
   - Document conversational patterns for future features

2. **Follow-up Stories** 
   - Story 2.3: Role-Based Context and Hallucination Mitigation
   - Consider enhanced relationship visualization features
   - Plan for conversation history persistence

3. **Monitoring Requirements**
   - Track session management performance
   - Monitor relationship query efficiency  
   - Measure user engagement with progressive disclosure

4. **Documentation Updates**
   - Update API documentation with new endpoints
   - Document session management security model
   - Create user guides for follow-up question patterns
