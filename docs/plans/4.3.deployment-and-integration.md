# Story 4.3 Deployment and Integration Plan

**Status**: Code Complete - Pending Deployment
**Date**: 2025-10-05
**Prerequisites**: All code committed, 21/21 tests passing

---

## Current State

### ✅ What's Complete
- [x] PDF Worker code (`apps/pdf_worker/main.py`)
- [x] FileProcessor refactored (`apps/chatbot/src/file_processor.py`)
- [x] Dependencies updated (`requirements.txt`)
- [x] Unit tests passing (13/13)
- [x] Security tests passing (8/8)
- [x] Code committed to git
- [x] main.py already imports and uses FileProcessor (lines 22, 42, 63, 178, 580, 586)

### ❌ What's NOT Done
- [ ] PDF Worker NOT deployed to Cloud Functions
- [ ] PDF_WORKER_URL NOT set in Cloud Run environment
- [ ] IAM permissions NOT configured
- [ ] Integration tests NOT run (require deployed worker)
- [ ] End-to-end file upload NOT tested in actual Chainlit app
- [ ] Cloud Armor rate limiting NOT configured

---

## Deployment Plan

### Phase 1: Deploy PDF Worker to Cloud Functions v2

**Prerequisites:**
- GCP project access with Cloud Functions admin permissions
- Cloud Functions v2 API enabled
- Billing enabled

**Steps:**

#### 1.1: Verify GCP Configuration
```bash
# Verify current project
gcloud config get-value project

# Verify Cloud Functions v2 API is enabled
gcloud services list --enabled | grep cloudfunctions

# If not enabled:
gcloud services enable cloudfunctions.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable artifactregistry.googleapis.com
```

#### 1.2: Deploy PDF Worker
```bash
cd apps/pdf_worker

# Deploy Cloud Functions v2
gcloud functions deploy pdf-worker \
  --gen2 \
  --region=us-central1 \
  --runtime=python312 \
  --source=. \
  --entry-point=app \
  --trigger-http \
  --no-allow-unauthenticated \
  --memory=512Mi \
  --timeout=60s \
  --max-instances=10 \
  --min-instances=0 \
  --ingress-settings=internal-only \
  --service-account=pdf-worker@PROJECT_ID.iam.gserviceaccount.com

# Get the function URL
FUNCTION_URL=$(gcloud functions describe pdf-worker \
  --gen2 \
  --region=us-central1 \
  --format='value(serviceConfig.uri)')

echo "PDF Worker URL: $FUNCTION_URL"
```

**Expected Output:**
```
Deploying function (may take a while - up to 2 minutes)...done.
availableMemoryMb: 512
buildId: ...
entryPoint: app
httpsTrigger:
  securityLevel: SECURE_ALWAYS
  url: https://us-central1-PROJECT_ID.cloudfunctions.net/pdf-worker
```

**Verification:**
```bash
# Should return 403 (not authenticated)
curl $FUNCTION_URL

# Expected: Forbidden or Unauthenticated
```

---

### Phase 2: Configure IAM Permissions

#### 2.1: Get Chainlit Service Account
```bash
# Get the service account used by Cloud Run
CHAINLIT_SA=$(gcloud run services describe cwe-chatbot \
  --region=us-central1 \
  --format='value(spec.template.spec.serviceAccountName)')

echo "Chainlit Service Account: $CHAINLIT_SA"
```

#### 2.2: Grant invoker Role
```bash
# Grant Chainlit SA permission to invoke PDF worker
gcloud functions add-iam-policy-binding pdf-worker \
  --gen2 \
  --region=us-central1 \
  --member="serviceAccount:$CHAINLIT_SA" \
  --role="roles/cloudfunctions.invoker"

echo "✅ Granted $CHAINLIT_SA permission to invoke pdf-worker"
```

**Verification:**
```bash
# List IAM bindings
gcloud functions get-iam-policy pdf-worker \
  --gen2 \
  --region=us-central1

# Should show:
# - members:
#   - serviceAccount:CHAINLIT_SA_EMAIL
#   role: roles/cloudfunctions.invoker
```

---

### Phase 3: Configure Cloud Run Environment

#### 3.1: Update Cloud Run with PDF_WORKER_URL
```bash
# Set environment variable
gcloud run services update cwe-chatbot \
  --region=us-central1 \
  --set-env-vars="PDF_WORKER_URL=$FUNCTION_URL"

echo "✅ Set PDF_WORKER_URL in Cloud Run"
```

#### 3.2: Verify Deployment
```bash
# Check environment variables
gcloud run services describe cwe-chatbot \
  --region=us-central1 \
  --format='value(spec.template.spec.containers[0].env)'

# Should show PDF_WORKER_URL
```

**Verification:**
```bash
# Check Cloud Run logs for startup
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=cwe-chatbot" \
  --limit=10 \
  --format=json

# Look for FileProcessor initialization
```

---

### Phase 4: Run Integration Tests

#### 4.1: Set Test Environment
```bash
cd /home/chris/work/CyberSecAI/cwe_chatbot_bmad

# Export PDF worker URL for integration tests
export PDF_WORKER_URL=$FUNCTION_URL

echo "PDF_WORKER_URL set for integration tests: $PDF_WORKER_URL"
```

#### 4.2: Run Integration Tests
```bash
# Run PDF worker integration tests
poetry run pytest apps/chatbot/tests/test_pdf_worker_integration.py -v

# Expected: Tests should pass if deployment successful
```

**Expected Output:**
```
test_pdf_worker_integration.py::TestPDFWorkerDeployment::test_worker_rejects_unauthenticated_requests PASSED
test_pdf_worker_integration.py::TestPDFWorkerDeployment::test_worker_security_headers PASSED
test_pdf_worker_integration.py::TestPDFWorkerDeployment::test_worker_rejects_missing_pdf_magic_bytes PASSED
test_pdf_worker_integration.py::TestPDFWorkerDeployment::test_worker_processes_valid_pdf PASSED
...
```

---

### Phase 5: End-to-End Testing

#### 5.1: Manual Testing Checklist

**Access Chainlit App:**
```bash
# Get Chainlit URL
gcloud run services describe cwe-chatbot \
  --region=us-central1 \
  --format='value(status.url)'
```

**Test Cases:**

1. **Valid PDF Upload (< 10MB, < 50 pages)**
   - [ ] Upload test PDF file
   - [ ] Verify text extraction displayed
   - [ ] Check no errors in UI
   - [ ] Verify Cloud Functions logs show processing

2. **Valid Text File Upload**
   - [ ] Upload .txt file
   - [ ] Verify content displayed
   - [ ] Check processed in-memory (no PDF worker called)

3. **Oversized File (> 10MB)**
   - [ ] Upload 11MB PDF
   - [ ] Verify "File exceeds 10MB limit" error
   - [ ] Check friendly error message (not technical)

4. **Encrypted PDF**
   - [ ] Upload password-protected PDF
   - [ ] Verify "Encrypted PDFs are not supported" error
   - [ ] Check error taxonomy working

5. **Binary File (Not PDF or Text)**
   - [ ] Upload .zip or .exe file
   - [ ] Verify "Unsupported file type" error

6. **PDF with JavaScript**
   - [ ] Upload PDF containing JavaScript
   - [ ] Verify successful processing
   - [ ] Confirm JavaScript removed (security test)

#### 5.2: Check Logs
```bash
# Check Cloud Run logs
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=cwe-chatbot" \
  --limit=50 \
  --format=json | grep -i "file\|pdf\|upload"

# Check Cloud Functions logs
gcloud logging read "resource.type=cloud_function AND resource.labels.function_name=pdf-worker" \
  --limit=50 \
  --format=json

# Verify NO file content in logs (only metadata)
```

#### 5.3: Performance Verification
```bash
# Check latency metrics in Cloud Console
# Navigate to: Cloud Functions > pdf-worker > Metrics
# Verify:
# - p50 < 2s
# - p95 < 5s
# - p99 < 10s
```

---

## Verification Checklist

### Deployment Verification
- [ ] Cloud Functions deployment successful
- [ ] Function URL obtained and working
- [ ] Internal ingress enforced (external calls return 403)
- [ ] Service account configured with minimal permissions

### IAM Verification
- [ ] Chainlit SA has roles/cloudfunctions.invoker on PDF worker
- [ ] Unauthenticated calls return 403
- [ ] OIDC token validation working

### Integration Verification
- [ ] PDF_WORKER_URL environment variable set in Cloud Run
- [ ] FileProcessor can call PDF worker successfully
- [ ] Integration tests passing (requires deployed worker)

### Functional Verification
- [ ] Upload valid PDF - text extracted
- [ ] Upload valid text - processed locally
- [ ] Upload > 10MB - friendly error
- [ ] Upload encrypted PDF - friendly error
- [ ] Upload binary file - friendly error
- [ ] Error taxonomy working (friendly messages, no error codes exposed)

### Security Verification
- [ ] No file content in logs (metadata only)
- [ ] No disk persistence (verified via logs/metrics)
- [ ] Security headers present (X-Content-Type-Options, Referrer-Policy, X-Frame-Options)
- [ ] PDF sanitization working (JavaScript removed)
- [ ] OIDC authentication enforced

### Performance Verification
- [ ] p50 latency < 2s
- [ ] p95 latency < 5s
- [ ] p99 latency < 10s
- [ ] Error rate < 1%

---

## Rollback Plan

### If PDF Worker Deployment Fails:
```bash
# Delete the function
gcloud functions delete pdf-worker \
  --gen2 \
  --region=us-central1

# File upload will gracefully fail with "PDF processing not configured"
```

### If Integration Issues:
```bash
# Disable PDF uploads temporarily
gcloud run services update cwe-chatbot \
  --region=us-central1 \
  --remove-env-vars=PDF_WORKER_URL

# Users will see "PDF processing not configured" error
```

### If Performance Issues:
```bash
# Reduce max instances
gcloud functions deploy pdf-worker \
  --gen2 \
  --region=us-central1 \
  --max-instances=5 \
  --update-env-vars=MAX_PAGES=25
```

---

## Success Criteria

### Code Complete ✅
- [x] All code written and committed
- [x] Unit tests passing (13/13)
- [x] Security tests passing (8/8)

### Deployment Complete (Pending)
- [ ] PDF Worker deployed to Cloud Functions v2
- [ ] IAM permissions configured
- [ ] Cloud Run environment updated
- [ ] Integration tests passing

### Production Ready (Pending)
- [ ] End-to-end testing complete
- [ ] Performance meets SLOs
- [ ] Security verification complete
- [ ] Documentation updated
- [ ] Story marked "Ready for Review"

---

## Notes

**Current Blockers**: None - ready for deployment

**Deployment Time Estimate**: 30-45 minutes
- Phase 1: Deploy PDF Worker (10 min)
- Phase 2: Configure IAM (5 min)
- Phase 3: Update Cloud Run (5 min)
- Phase 4: Integration tests (5 min)
- Phase 5: E2E testing (15-20 min)

**Deployment Risk**: Low
- Code thoroughly tested in isolation
- Rollback plan available
- Graceful degradation (PDF uploads fail with friendly message if worker unavailable)
