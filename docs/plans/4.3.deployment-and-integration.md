# Story 4.3 Deployment and Integration Plan

**Status**: Code Complete - Pending Deployment
**Date**: 2025-10-05
**Prerequisites**: All code committed, 21/21 tests passing

---

## Current State

### ✅ What's Complete
- [x] PDF Worker code (`apps/pdf_worker/main.py`)
- [x] FileProcessor refactored (`apps/chatbot/src/file_processor.py`)
- [x] Dependencies updated (`requirements.txt`)
- [x] Unit tests passing (13/13)
- [x] Security tests passing (8/8)
- [x] Code committed to git
- [x] main.py already imports and uses FileProcessor (lines 22, 42, 63, 178, 580, 586)

### ❌ What's NOT Done
- [ ] PDF Worker NOT deployed to Cloud Functions
- [ ] PDF_WORKER_URL NOT set in Cloud Run environment
- [ ] IAM permissions NOT configured
- [ ] Integration tests NOT run (require deployed worker)
- [ ] End-to-end file upload NOT tested in actual Chainlit app
- [ ] Cloud Armor rate limiting NOT configured

---

## Deployment Plan
Phase 1: Deploy PDF Worker to Cloud Functions v2

Prereqs: Project access, billing enabled, APIs enabled (cloudfunctions.googleapis.com, run.googleapis.com, artifactregistry.googleapis.com).

1.1 Verify GCP Configuration
# Verify current project
PROJECT_ID=$(gcloud config get-value project)
echo $PROJECT_ID


# Enable required services (idempotent)
gcloud services enable \
  cloudfunctions.googleapis.com \
  run.googleapis.com \
  artifactregistry.googleapis.com
1.2 Deploy PDF Worker (two‑step to set EXPECTED_AUDIENCE)

Why two steps? The function URL isn’t known until after the first deploy; we then pin EXPECTED_AUDIENCE for explicit aud verification.

REGION=us-central1
SA_PDF_WORKER=pdf-worker@${PROJECT_ID}.iam.gserviceaccount.com


cd apps/pdf_worker


# Step A: initial deploy (placeholder audience)
gcloud functions deploy pdf-worker \
  --gen2 \
  --region=$REGION \
  --runtime=python312 \
  --source=. \
  --entry-point=function_entry \
  --trigger-http \
  --no-allow-unauthenticated \
  --memory=512Mi \
  --timeout=60s \
  --max-instances=10 \
  --min-instances=0 \
  --ingress-settings=internal-only \
  --service-account=$SA_PDF_WORKER \
  --set-env-vars=EXPECTED_AUDIENCE=PLACEHOLDER


# Discover function URL (audience for ID token)
FUNCTION_URL=$(gcloud functions describe pdf-worker \
  --gen2 --region=$REGION \
  --format='value(serviceConfig.uri)')


echo "PDF Worker URL: $FUNCTION_URL"


# Step B: redeploy with correct EXPECTED_AUDIENCE
gcloud functions deploy pdf-worker \
  --gen2 \
  --region=$REGION \
  --runtime=python312 \
  --source=. \
  --entry-point=function_entry \
  --trigger-http \
  --no-allow-unauthenticated \
  --memory=512Mi \
  --timeout=60s \
  --max-instances=10 \
  --min-instances=0 \
  --ingress-settings=internal-only \
  --service-account=$SA_PDF_WORKER \
  --set-env-vars=EXPECTED_AUDIENCE=${FUNCTION_URL}
1.3 Verification
# Unauth call should fail (401/403)
curl -sS -i "$FUNCTION_URL" | head -n 20
Phase 2: Configure IAM Permissions
2.1 Identify Chainlit Service Account
REGION=us-central1
CHAINLIT_SA=$(gcloud run services describe cwe-chatbot \
  --region=$REGION \
  --format='value(spec.template.spec.serviceAccountName)')


echo "Chainlit SA: $CHAINLIT_SA"
2.2 Grant Invoker on the Function (CF v2 role)
gcloud functions add-iam-policy-binding pdf-worker \
  --gen2 --region=$REGION \
  --member="serviceAccount:$CHAINLIT_SA" \
  --role="roles/cloudfunctions.invoker"
2.3 IAM Policy Check
gcloud functions get-iam-policy pdf-worker \
  --gen2 --region=$REGION
# Expect roles/cloudfunctions.invoker for serviceAccount:${CHAINLIT_SA}
Phase 3: Configure Cloud Run Environment (Chainlit)
3.1 Set PDF_WORKER_URL
gcloud run services update cwe-chatbot \
  --region=$REGION \
  --set-env-vars="PDF_WORKER_URL=${FUNCTION_URL}"
3.2 Verify Env & Startup
gcloud run services describe cwe-chatbot \
  --region=$REGION \
  --format='value(spec.template.spec.containers[0].env)'


# Logs (Chainlit)
gcloud logging read \
  'resource.type="cloud_run_revision" AND resource.labels.service_name="cwe-chatbot"' \
  --limit=50 --format=json
Phase 4: Run Integration Tests
4.1 Test Env
export PDF_WORKER_URL=${FUNCTION_URL}
4.2 Execute
poetry run pytest apps/chatbot/tests/test_pdf_worker_integration.py -v
4.3 Add Negative Auth Cases

Missing bearer → 401/403

Wrong audience → 401/403

Phase 5: End‑to‑End Testing (Manual)
5.1 Get Chainlit URL
gcloud run services describe cwe-chatbot \
  --region=$REGION \
  --format='value(status.url)'
5.2 Test Cases

Valid PDF (<10MB, <50 pages) → text extracted; UI shows success; function logs show request (metadata only).

Valid text → processed locally; worker not called.

Oversized (11MB) → friendly error.

Encrypted PDF → friendly error (encrypted_pdf_unsupported).

Binary (zip/exe) → friendly error (binary_text_rejected / invalid_content_type).

PDF with JavaScript → processed; confirm JS removed.

5.3 Logs
# Chainlit (Cloud Run)
gcloud logging read \
  'resource.type="cloud_run_revision" AND resource.labels.service_name="cwe-chatbot"' \
  --limit=50 --format=json | grep -E "file|pdf|upload|edi|worker" -i


# PDF Worker (Functions v2 often surfaces under Cloud Run)
gcloud logging read \
  'resource.type="cloud_run_revision" AND resource.labels.service_name="pdf-worker"' \
  --limit=50 --format=json


# (Fallback Gen1 style, rarely needed)
gcloud logging read \
  'resource.type="cloud_function" AND resource.labels.function_name="pdf-worker"' \
  --limit=50 --format=json
5.4 Performance (Console)

Check Functions v2 metrics for latency SLOs: p50 < 2s, p95 < 5s, p99 < 10s.

Phase 6: Edge – HTTPS LB + Cloud Armor Rate Limiting (Chainlit)

Chainlit remains on Cloud Run. Put an External HTTPS Load Balancer in front using a Serverless NEG, attach a Cloud Armor policy for rate limiting. Set Chainlit ingress to internal-and-cloud-load-balancing so it’s reachable only via the LB.

6.1 Update Chainlit Ingress
gcloud run services update cwe-chatbot \
  --region=$REGION \
  --ingress internal-and-cloud-load-balancing
6.2 Create Cloud Armor Policy
gcloud compute security-policies create chainlit-armor --type=ADVANCED


gcloud compute security-policies rules create 1000 \
  --security-policy=chainlit-armor \
  --expression "true" \
  --action "throttle" \
  --rate-limit-threshold-count 20 \
  --rate-limit-threshold-interval-sec 60 \
  --conform-action "allow" \
  --exceed-action "deny(429)" \
  --enforce-on-key "IP"
# Optional per-session header key:
#   use a second rule with --enforce-on-key=HTTP_HEADER --rate-limit-key=header:x-session-key
6.3 Create Serverless NEG & Backend
# Serverless NEG pointing to Chainlit
gcloud compute network-endpoint-groups create neg-chainlit \
  --region=$REGION \
  --network-endpoint-type=serverless \
  --cloud-run-service=cwe-chatbot


# Backend service with Cloud Armor
gcloud compute backend-services create be-chainlit \
  --global \
  --load-balancing-scheme=EXTERNAL_MANAGED \
  --security-policy=chainlit-armor


gcloud compute backend-services add-backend be-chainlit \
  --global \
  --network-endpoint-group=neg-chainlit \
  --network-endpoint-group-region=$REGION
6.4 URL Map, HTTPS Proxy, Cert, Forwarding Rule
# Managed cert
DOMAIN_NAME=your.domain.tld
gcloud compute ssl-certificates create lb-cert \
  --domains=$DOMAIN_NAME \
  --global


# URL map
gcloud compute url-maps create url-map-chainlit \
  --default-service=be-chainlit


# HTTPS proxy
gcloud compute target-https-proxies create https-proxy-chainlit \
  --url-map=url-map-chainlit \
  --ssl-certificates=lb-cert


# Global forwarding rule
gcloud compute forwarding-rules create fr-https-chainlit \
  --global \
  --target-https-proxy=https-proxy-chainlit \
  --ports=443
6.5 Verify Enforcement
# Hit LB DNS once cert is active; exceed 20 req/min from a single IP and expect 429
Additional Security & App Notes

ID Token vs Access Token: Chainlit must mint an OIDC ID token (metadata server identity endpoint) with aud=${FUNCTION_URL} and send Authorization: Bearer <token>.

Flask security headers: Ensure worker sets: X-Content-Type-Options: nosniff, Referrer-Policy: no-referrer, X-Frame-Options: DENY, Permissions-Policy: geolocation=(), microphone=().

No redirects: Chainlit HTTP client should not follow redirects to avoid token leakage.

No content logging: Metadata-only logs; never log user payloads/snippets.

Parametrize region/project: Use ${REGION} and ${PROJECT_ID} to avoid drift.

---

## Verification Checklist

### Deployment Verification
- [ ] Cloud Functions deployment successful
- [ ] Function URL obtained and working
- [ ] Internal ingress enforced (external calls return 403)
- [ ] Service account configured with minimal permissions

### IAM Verification
- [ ] Chainlit SA has roles/cloudfunctions.invoker on PDF worker
- [ ] Unauthenticated calls return 403
- [ ] OIDC token validation working

### Integration Verification
- [ ] PDF_WORKER_URL environment variable set in Cloud Run
- [ ] FileProcessor can call PDF worker successfully
- [ ] Integration tests passing (requires deployed worker)

### Functional Verification
- [ ] Upload valid PDF - text extracted
- [ ] Upload valid text - processed locally
- [ ] Upload > 10MB - friendly error
- [ ] Upload encrypted PDF - friendly error
- [ ] Upload binary file - friendly error
- [ ] Error taxonomy working (friendly messages, no error codes exposed)

### Security Verification
- [ ] No file content in logs (metadata only)
- [ ] No disk persistence (verified via logs/metrics)
- [ ] Security headers present (X-Content-Type-Options, Referrer-Policy, X-Frame-Options)
- [ ] PDF sanitization working (JavaScript removed)
- [ ] OIDC authentication enforced

### Performance Verification
- [ ] p50 latency < 2s
- [ ] p95 latency < 5s
- [ ] p99 latency < 10s
- [ ] Error rate < 1%

---

## Rollback Plan

### If PDF Worker Deployment Fails:
```bash
# Delete the function
gcloud functions delete pdf-worker \
  --gen2 \
  --region=us-central1

# File upload will gracefully fail with "PDF processing not configured"
```

### If Integration Issues:
```bash
# Disable PDF uploads temporarily
gcloud run services update cwe-chatbot \
  --region=us-central1 \
  --remove-env-vars=PDF_WORKER_URL

# Users will see "PDF processing not configured" error
```

### If Performance Issues:
```bash
# Reduce max instances
gcloud functions deploy pdf-worker \
  --gen2 \
  --region=us-central1 \
  --max-instances=5 \
  --update-env-vars=MAX_PAGES=25
```

---

## Success Criteria

### Code Complete ✅
- [x] All code written and committed
- [x] Unit tests passing (13/13)
- [x] Security tests passing (8/8)

### Deployment Complete (Pending)
- [ ] PDF Worker deployed to Cloud Functions v2
- [ ] IAM permissions configured
- [ ] Cloud Run environment updated
- [ ] Integration tests passing

### Production Ready (Pending)
- [ ] End-to-end testing complete
- [ ] Performance meets SLOs
- [ ] Security verification complete
- [ ] Documentation updated
- [ ] Story marked "Ready for Review"

---

## Notes

**Current Blockers**: None - ready for deployment

**Deployment Time Estimate**: 30-45 minutes
- Phase 1: Deploy PDF Worker (10 min)
- Phase 2: Configure IAM (5 min)
- Phase 3: Update Cloud Run (5 min)
- Phase 4: Integration tests (5 min)
- Phase 5: E2E testing (15-20 min)

**Deployment Risk**: Low
- Code thoroughly tested in isolation
- Rollback plan available
- Graceful degradation (PDF uploads fail with friendly message if worker unavailable)
